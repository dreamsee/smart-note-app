// 통합 뷰 채팅 표시 유틸리티
import { 채팅메시지타입, 노트타입, 폴더설정타입 } from '../타입';

// 🔥 채팅 메시지 표시 로직
export class 채팅표시유틸리티 {
  
  /**
   * 노트의 채팅 메시지를 설정에 따라 필터링하여 반환
   */
  static 표시할메시지목록가져오기(
    노트: 노트타입, 
    폴더설정: 폴더설정타입
  ): {
    표시메시지목록: 채팅메시지타입[];
    숨겨진메시지개수: number;
    전체메시지개수: number;
  } {
    const 전체메시지목록 = 노트.채팅메시지목록;
    
    // 노트별 설정이 있으면 사용, 없으면 폴더 기본 설정 사용
    const 채팅설정 = 노트.노트설정?.채팅표시설정 || {
      최대표시개수: 폴더설정.기본채팅표시설정.최대표시개수,
      표시순서: 폴더설정.기본채팅표시설정.표시순서,
      스크롤표시여부: 폴더설정.기본채팅표시설정.스크롤표시여부
    };
    
    // 모든 메시지 (하위 메시지 포함) 평탄화
    const 평탄화된메시지목록 = this.메시지목록평탄화하기(전체메시지목록);
    
    // 정렬
    const 정렬된메시지목록 = this.메시지목록정렬하기(평탄화된메시지목록, 채팅설정.표시순서);
    
    // 표시할 메시지 개수 제한
    const 표시메시지목록 = 정렬된메시지목록.slice(0, 채팅설정.최대표시개수);
    const 숨겨진메시지개수 = Math.max(0, 정렬된메시지목록.length - 채팅설정.최대표시개수);
    
    return {
      표시메시지목록,
      숨겨진메시지개수,
      전체메시지개수: 정렬된메시지목록.length
    };
  }
  
  /**
   * 모든 메시지 (하위 메시지 포함)를 평탄화
   */
  private static 메시지목록평탄화하기(메시지목록: 채팅메시지타입[]): 채팅메시지타입[] {
    const 결과: 채팅메시지타입[] = [];
    
    for (const 메시지 of 메시지목록) {
      결과.push(메시지);
      
      // 하위 메시지가 있으면 재귀적으로 추가
      if (메시지.하위메시지목록 && 메시지.하위메시지목록.length > 0) {
        결과.push(...this.메시지목록평탄화하기(메시지.하위메시지목록));
      }
    }
    
    return 결과;
  }
  
  /**
   * 메시지 목록을 설정에 따라 정렬
   */
  private static 메시지목록정렬하기(
    메시지목록: 채팅메시지타입[], 
    정렬순서: '최신순' | '시간순'
  ): 채팅메시지타입[] {
    const 복사된목록 = [...메시지목록];
    
    if (정렬순서 === '최신순') {
      // 최신순: 최근 메시지부터
      return 복사된목록.sort((a, b) => b.타임스탬프.getTime() - a.타임스탬프.getTime());
    } else {
      // 시간순: 오래된 메시지부터
      return 복사된목록.sort((a, b) => a.타임스탬프.getTime() - b.타임스탬프.getTime());
    }
  }
  
  /**
   * 숨겨진 메시지 표시용 요약 텍스트 생성
   */
  static 숨겨진메시지요약생성하기(숨겨진개수: number): string {
    if (숨겨진개수 === 0) return '';
    return `⋯ ${숨겨진개수}개의 추가 메시지가 있습니다`;
  }
}

// 🔥 요약 표시 로직
export class 요약표시유틸리티 {
  
  /**
   * 노트의 요약 표시 설정 가져오기
   */
  static 요약표시설정가져오기(노트: 노트타입, 폴더설정: 폴더설정타입) {
    return 노트.노트설정?.요약표시설정 || {
      기본상태: 폴더설정.기본요약표시설정.기본상태,
      접힘시위치: 폴더설정.기본요약표시설정.접힘시위치,
      자동요약생성: 폴더설정.기본요약표시설정.자동요약생성
    };
  }
  
  /**
   * 요약이 비어있는지 확인
   */
  static 요약이비어있는지확인(노트: 노트타입): boolean {
    return !노트.요약 || 노트.요약.trim().length === 0;
  }
  
  /**
   * 자동 요약 생성 (향후 확장용 - 현재는 기본 구현)
   */
  static 자동요약생성하기(노트: 노트타입): string {
    const 메시지수 = 노트.채팅메시지목록.length;
    const 최근메시지 = 노트.채팅메시지목록[노트.채팅메시지목록.length - 1];
    
    if (메시지수 === 0) return '내용이 없습니다.';
    if (메시지수 === 1) return `"${최근메시지.텍스트.slice(0, 50)}${최근메시지.텍스트.length > 50 ? '...' : ''}"`;
    
    return `${메시지수}개의 메시지가 있습니다. 최근: "${최근메시지.텍스트.slice(0, 30)}${최근메시지.텍스트.length > 30 ? '...' : ''}"`;
  }
}

// 🔥 기본 설정값 상수
export const 기본채팅표시설정 = {
  최대표시개수: 7,
  표시순서: '최신순' as const,
  스크롤표시여부: true
};

export const 기본요약표시설정 = {
  기본상태: '접힘' as const,
  접힘시위치: '하단' as const,
  자동요약생성: false
};