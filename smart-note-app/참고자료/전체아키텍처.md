# 채팅형 스마트 노트 시스템 설계 문서

## 1. 시스템 개요

### 1.1 프로젝트 목표
- 채팅 인터페이스와 체계적 노트 정리를 결합한 스마트 노트 시스템
- 좌우 패널 분할: 왼쪽(채팅 영역) + 오른쪽(노트 영역)
- 폴더 기반 조직화 및 다중 입력 방식 지원

### 1.2 기술 스택
- **Frontend**: React 18 + TypeScript
- **상태관리**: React Context API
- **데이터베이스**: Supabase (PostgreSQL)
- **스타일링**: CSS Modules
- **빌드도구**: Create React App

## 2. 시스템 아키텍처

### 2.1 컴포넌트 구조
```
src/
├── 타입/
│   └── index.ts                    # 전체 타입 정의
├── 상태관리/
│   ├── 앱상태.tsx                  # 기존 localStorage 상태 (deprecated)
│   └── supabase상태.tsx            # Supabase 상태 관리
├── 서비스/
│   ├── supabase.ts                 # Supabase 클라이언트 설정
│   └── 데이터베이스서비스.ts        # 데이터베이스 CRUD 서비스
├── 컴포넌트/
│   ├── 채팅패널.tsx                # 좌측 채팅 인터페이스
│   ├── 노트패널.tsx                # 우측 노트 편집 영역
│   ├── 폴더목록.tsx                # 폴더 목록 사이드바
│   ├── 폴더설정모달.tsx            # 폴더 설정 모달
│   ├── 폴더통합뷰.tsx              # 폴더 통합 뷰
│   ├── 대화형입력.tsx              # 대화형 입력 컴포넌트
│   ├── 카테고리입력.tsx            # 카테고리형 입력 컴포넌트
│   └── 설정패널.tsx                # 전체 설정 패널
└── App.tsx                        # 메인 앱 컴포넌트
```

### 2.2 데이터 흐름
1. **Supabase 클라이언트** → **데이터베이스서비스** → **Supabase상태컨텍스트** → **컴포넌트들**
2. 모든 데이터 변경은 Supabase를 통해 처리
3. 실시간 동기화 및 로컬 상태 캐싱

## 3. 데이터베이스 스키마

### 3.1 테이블 구조

#### 폴더목록 테이블
```sql
CREATE TABLE 폴더목록 (
    아이디 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    이름 VARCHAR(255) NOT NULL,
    폴더설정 JSONB NOT NULL,
    생성시간 TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    수정시간 TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    사용자아이디 UUID REFERENCES auth.users(id) ON DELETE CASCADE
);
```

#### 노트목록 테이블
```sql
CREATE TABLE 노트목록 (
    아이디 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    폴더아이디 UUID NOT NULL REFERENCES 폴더목록(아이디) ON DELETE CASCADE,
    제목 VARCHAR(500) NOT NULL,
    내용 TEXT DEFAULT '',
    요약 TEXT,
    태그목록 VARCHAR(100)[],
    생성시간 TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    수정시간 TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 채팅메시지목록 테이블
```sql
CREATE TABLE 채팅메시지목록 (
    아이디 UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    노트아이디 UUID NOT NULL REFERENCES 노트목록(아이디) ON DELETE CASCADE,
    부모메시지아이디 UUID REFERENCES 채팅메시지목록(아이디) ON DELETE CASCADE,
    텍스트 TEXT NOT NULL,
    작성자 VARCHAR(100),
    카테고리 VARCHAR(50),
    타임스탬프 TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3.2 인덱스 및 제약조건
```sql
-- 성능 최적화를 위한 인덱스
CREATE INDEX idx_노트목록_폴더아이디 ON 노트목록(폴더아이디);
CREATE INDEX idx_채팅메시지목록_노트아이디 ON 채팅메시지목록(노트아이디);
CREATE INDEX idx_채팅메시지목록_부모메시지아이디 ON 채팅메시지목록(부모메시지아이디);

-- 수정시간 자동 업데이트 트리거
CREATE OR REPLACE FUNCTION update_수정시간_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.수정시간 = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_폴더목록_수정시간 BEFORE UPDATE ON 폴더목록 FOR EACH ROW EXECUTE FUNCTION update_수정시간_column();
CREATE TRIGGER update_노트목록_수정시간 BEFORE UPDATE ON 노트목록 FOR EACH ROW EXECUTE FUNCTION update_수정시간_column();
```

## 4. 핵심 타입 정의

### 4.1 기본 타입
```typescript
// 폴더 설정 타입
interface 폴더설정타입 {
  시간표시여부: boolean;
  입력방식: '단순채팅' | '카테고리형' | '대화형';
  하위입력활성화: boolean;
  카테고리목록?: string[];
  캐릭터목록?: string[];
  디자인테마?: string;
}

// 채팅 메시지 타입
interface 채팅메시지타입 {
  아이디: string;
  텍스트: string;
  타임스탬프: Date;
  작성자?: string;
  카테고리?: string;
  하위메시지목록: 채팅메시지타입[];
}

// 노트 타입
interface 노트타입 {
  아이디: string;
  제목: string;
  내용: string;
  요약?: string;
  태그목록?: string[];
  채팅메시지목록: 채팅메시지타입[];
  생성시간: Date;
  수정시간: Date;
}

// 폴더 타입
interface 폴더타입 {
  아이디: string;
  이름: string;
  노트목록: 노트타입[];
  폴더설정: 폴더설정타입;
}
```

## 5. API 서비스 설계

### 5.1 데이터베이스서비스 클래스
```typescript
class 데이터베이스서비스 {
  // 폴더 관련
  async 폴더목록가져오기(): Promise<폴더타입[]>
  async 폴더생성하기(폴더이름: string, 폴더설정: 폴더설정타입): Promise<string>
  async 폴더삭제하기(폴더아이디: string): Promise<void>
  async 폴더이름변경하기(폴더아이디: string, 새이름: string): Promise<void>
  async 폴더설정업데이트하기(폴더아이디: string, 새설정: Partial<폴더설정타입>): Promise<void>
  
  // 노트 관련
  async 노트생성하기(폴더아이디: string, 노트제목: string): Promise<string>
  async 노트삭제하기(노트아이디: string): Promise<void>
  async 노트업데이트하기(노트아이디: string, 업데이트내용: Partial<노트타입>): Promise<void>
  
  // 메시지 관련
  async 메시지추가하기(노트아이디: string, 메시지텍스트: string, 옵션?: MessageOptions): Promise<string>
  
  // 마이그레이션
  async localStorage데이터마이그레이션하기(localStorage데이터: 폴더타입[]): Promise<void>
}
```

## 6. 입력 방식별 UI 설계

### 6.1 단순 채팅 방식
- 기본 텍스트 입력창
- 타임스탬프 표시 (옵션)
- 하위 메시지 지원 (옵션)

### 6.2 카테고리형 방식
- 좌측 카테고리 선택 영역 (20%)
- 우측 텍스트 입력 영역 (80%)
- 사전 정의된 카테고리 목록
- 카테고리별 색상 구분

### 6.3 대화형 방식
- 캐릭터 선택 드롭다운
- 말풍선 위치 설정 (좌/우)
- 캐릭터별 아바타 표시
- 대화형 버블 UI

## 7. 상태 관리 설계

### 7.1 Supabase상태컨텍스트
```typescript
interface Supabase상태컨텍스트타입 {
  // 상태
  폴더목록: 폴더타입[];
  활성폴더: 폴더타입 | null;
  활성노트: 노트타입 | null;
  로딩중: boolean;
  에러: string | null;
  
  // 액션 함수들
  폴더선택하기: (폴더아이디: string) => void;
  새폴더생성하기: (폴더이름: string) => Promise<void>;
  // ... 기타 CRUD 함수들
}
```

### 7.2 로컬 상태 동기화
- localStorage에 활성 상태 저장
- 페이지 새로고침 시 상태 복원
- 에러 처리 및 사용자 피드백

## 8. 보안 및 성능 고려사항

### 8.1 보안
- Supabase Row Level Security (RLS) 적용
- 사용자별 데이터 격리
- 입력 데이터 검증 및 살균

### 8.2 성능
- 컴포넌트 레벨 최적화 (React.memo, useMemo)
- 지연 로딩 및 페이지네이션
- 데이터베이스 쿼리 최적화

## 9. 마이그레이션 계획

### 9.1 localStorage → Supabase 마이그레이션
1. 기존 localStorage 데이터 백업
2. Supabase 스키마 생성
3. 데이터 변환 및 이관
4. 컴포넌트 상태 관리 전환
5. 기존 localStorage 데이터 정리

### 9.2 호환성 유지
- 기존 API 인터페이스 유지
- 점진적 마이그레이션 지원
- 롤백 계획 준비

## 10. 향후 확장 계획

### 10.1 추가 기능
- 실시간 협업 기능
- 파일 첨부 및 미디어 지원
- 고급 검색 및 필터링
- 템플릿 시스템

### 10.2 성능 개선
- 캐싱 전략 최적화
- 오프라인 지원
- PWA 전환
- 모바일 최적화