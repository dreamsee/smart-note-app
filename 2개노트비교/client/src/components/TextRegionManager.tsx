import { useState, useRef, useEffect } from 'react';
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter, DialogDescription } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Trash2, Edit2, FolderPlus, ChevronDown, ChevronRight, GripVertical, Grid, Plus, MapPin } from "lucide-react";
import { cn } from "@/lib/utils";

// ÌÉÄÏûÖ Ï†ïÏùò
interface TextRegion {
  id: string;
  name: string;
  startLine: number;
  startChar: number;
  endLine: number;
  endChar: number;
  originalValue: string;
  modifiedValue: string;
  categoryId: string;
  type?: 'single' | 'table';
  tableData?: TableRegionData;
}

interface TableRegionData {
  headers: string[];
  rows: TableRow[];
}

interface TableRow {
  label: string;
  cells: TableCell[];
}

interface TableCell {
  id: string;
  value: string;
  startLine: number;
  startChar: number;
  endLine: number;
  endChar: number;
  originalValue: string;
  modifiedValue: string;
}

interface Category {
  id: string;
  name: string;
  color: string;
  isCollapsed: boolean;
  order: number;
}

interface LineGroup {
  id: string;
  name: string;
  lines: number[];
  isVisible: boolean;
  isCollapsed: boolean;
  color: string;
}

interface TextRegionManagerProps {
  text: string;
  onTextChange: (newText: string) => void;
  modifiedDocumentId?: number;
  onRegionDataChange?: (regionData: { categories: Category[], regions: TextRegion[], lineGroups?: LineGroup[] }) => void;
  initialRegionData?: any;
}

const COLORS = [
  '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
  '#8b5cf6', '#06b6d4', '#84cc16', '#f97316'
];

export default function TextRegionManager({ text, onTextChange, modifiedDocumentId, onRegionDataChange, initialRegionData }: TextRegionManagerProps) {
  const [regions, setRegions] = useState<TextRegion[]>([]);
  const [categories, setCategories] = useState<Category[]>([
    { id: 'default', name: 'Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨', color: '#6b7280', isCollapsed: false, order: 0 }
  ]);
  const [isSelectionMode, setIsSelectionMode] = useState<boolean>(false);
  const [pendingSelection, setPendingSelection] = useState<{
    startLine: number;
    startChar: number;
    endLine: number;
    endChar: number;
    selectedText: string;
  } | null>(null);

  // Ï§Ñ Í∑∏Î£π Í¥ÄÎ¶¨ ÏÉÅÌÉú
  const [lineGroups, setLineGroups] = useState<LineGroup[]>([]);
  const [selectedLines, setSelectedLines] = useState<number[]>([]);
  const [showAllLines, setShowAllLines] = useState<boolean>(true);
  const [isLineSelectionMode, setIsLineSelectionMode] = useState<boolean>(false);
  const [newGroupName, setNewGroupName] = useState<string>('');
  const [showGroupDialog, setShowGroupDialog] = useState<boolean>(false);
  const [isGroupPanelCollapsed, setIsGroupPanelCollapsed] = useState<boolean>(false);
  const [editingGroupId, setEditingGroupId] = useState<string | null>(null);
  const [editingGroupName, setEditingGroupName] = useState<string>('');
  const [lineNumberInput, setLineNumberInput] = useState<string>('');
  


  // ÏòÅÏó≠ Í¥ÄÎ¶¨ Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞ (Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú)
  const regionData = null; // ÏÑúÎ≤Ñ ÏóÜÏù¥ Î°úÏª¨ÏóêÏÑú Í¥ÄÎ¶¨

  // ÏàòÏ†ïÎêú Î¨∏ÏÑúÏùò regionDataÎ•º Î°úÎìúÌïòÎäî useEffect
  useEffect(() => {
    if (modifiedDocumentId) {
      // localStorageÏóêÏÑú ÏàòÏ†ïÎêú Î¨∏ÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      const modifiedDocs = JSON.parse(localStorage.getItem('modifiedDocuments') || '[]');
      const currentDoc = modifiedDocs.find((doc: any) => doc.id === modifiedDocumentId);
      
      console.log(`üì• [REGION DEBUG] ÏàòÏ†ïÎêú Î¨∏ÏÑú ID ${modifiedDocumentId}Ïùò regionData Î°úÎìú ÏãúÎèÑ`);
      console.log(`üì• [REGION DEBUG] Ï∞æÏùÄ Î¨∏ÏÑú:`, currentDoc);
      
      if (currentDoc && currentDoc.regionData) {
        console.log(`üì• [REGION DEBUG] regionData Î∞úÍ≤¨:`, currentDoc.regionData);
        const { categories, regions, lineGroups } = currentDoc.regionData;
        
        if (categories && categories.length > 0) {
          setCategories(categories);
          console.log(`üì• [REGION DEBUG] Ïπ¥ÌÖåÍ≥†Î¶¨ ${categories.length}Í∞ú Î°úÎìúÎê®`);
        }
        
        if (regions && regions.length > 0) {
          setRegions(regions);
          console.log(`üì• [REGION DEBUG] ÏòÅÏó≠ ${regions.length}Í∞ú Î°úÎìúÎê®`);
        }
        
        if (lineGroups && lineGroups.length > 0) {
          setLineGroups(lineGroups);
          console.log(`üì• [REGION DEBUG] Ï§Ñ Í∑∏Î£π ${lineGroups.length}Í∞ú Î°úÎìúÎê®`);
        }
      } else {
        console.log(`üì• [REGION DEBUG] regionData ÏóÜÏùå, Í∏∞Î≥∏ ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞Ìôî`);
        setCategories([
          { id: 'default', name: 'Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨', color: '#6b7280', isCollapsed: false, order: 0 }
        ]);
        setRegions([]);
        setLineGroups([]);
      }
    } else {
      console.log(`üì• [REGION DEBUG] modifiedDocumentId ÏóÜÏùå, Í∏∞Î≥∏ ÏÉÅÌÉúÎ°ú Ï¥àÍ∏∞Ìôî`);
      setCategories([
        { id: 'default', name: 'Í∏∞Î≥∏ Ïπ¥ÌÖåÍ≥†Î¶¨', color: '#6b7280', isCollapsed: false, order: 0 }
      ]);
      setRegions([]);
      setLineGroups([]);
    }
  }, [modifiedDocumentId]);

  // ÏòÅÏó≠ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤Ω Ïãú Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏Ïóê ÏïåÎ¶º
  useEffect(() => {
    if (onRegionDataChange) {
      console.log(`üì§ [REGION DEBUG] Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏Î°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÎã¨:`, { categories, regions, lineGroups });
      onRegionDataChange({ categories, regions, lineGroups });
    } else {
      console.log(`üì§ [REGION DEBUG] onRegionDataChange ÏΩúÎ∞±Ïù¥ ÏóÜÏùå`);
    }
  }, [categories, regions, lineGroups, onRegionDataChange]);

  // Ï§Ñ Î≤àÌò∏ ÌÖçÏä§Ìä∏ ÌååÏã± Ìï®Ïàò
  const parseLineNumbers = (input: string): number[] => {
    if (!input.trim()) return [];
    
    const result: number[] = [];
    const parts = input.split(',').map(part => part.trim());
    
    for (const part of parts) {
      if (part.includes('-')) {
        // Î≤îÏúÑ Ï≤òÎ¶¨ (Ïòà: 5-9)
        const [start, end] = part.split('-').map(num => parseInt(num.trim()));
        if (!isNaN(start) && !isNaN(end) && start <= end) {
          for (let i = start; i <= end; i++) {
            if (i > 0 && i <= text.split('\n').length) {
              result.push(i - 1); // 0-based indexÎ°ú Î≥ÄÌôò
            }
          }
        }
      } else {
        // Í∞úÎ≥Ñ Î≤àÌò∏ Ï≤òÎ¶¨ (Ïòà: 1, 3, 5)
        const num = parseInt(part);
        if (!isNaN(num) && num > 0 && num <= text.split('\n').length) {
          result.push(num - 1); // 0-based indexÎ°ú Î≥ÄÌôò
        }
      }
    }
    
    // Ï§ëÎ≥µ Ï†úÍ±∞ Î∞è Ï†ïÎ†¨
    const uniqueResult = result.filter((value, index, self) => self.indexOf(value) === index);
    return uniqueResult.sort((a, b) => a - b);
  };

  // ÌÖçÏä§Ìä∏ ÏûÖÎ†•ÏúºÎ°ú Ï§Ñ ÏÑ†ÌÉùÌïòÍ∏∞
  const selectLinesFromInput = () => {
    const lineNumbers = parseLineNumbers(lineNumberInput);
    if (lineNumbers.length > 0) {
      setSelectedLines(lineNumbers);
      setLineNumberInput(''); // ÏûÖÎ†•Ï∞Ω Ï¥àÍ∏∞Ìôî
    }
  };

  // Ï§Ñ Í∑∏Î£π Í¥ÄÎ¶¨ Ìï®ÏàòÎì§
  const toggleLineSelection = (lineNumber: number) => {
    if (!isLineSelectionMode) return;
    
    setSelectedLines(prev => {
      if (prev.includes(lineNumber)) {
        return prev.filter(line => line !== lineNumber);
      } else {
        return [...prev, lineNumber].sort((a, b) => a - b);
      }
    });
  };

  const createLineGroup = () => {
    if (selectedLines.length === 0 || !newGroupName.trim()) return;
    
    const newGroup: LineGroup = {
      id: Date.now().toString(),
      name: newGroupName.trim(),
      lines: [...selectedLines],
      isVisible: true,
      isCollapsed: false,
      color: COLORS[lineGroups.length % COLORS.length]
    };
    
    console.log('üìù [LINE GROUP DEBUG] ÏÉà Ï§Ñ Í∑∏Î£π ÏÉùÏÑ±:', newGroup);
    setLineGroups(prev => {
      const updated = [...prev, newGroup];
      console.log('üìù [LINE GROUP DEBUG] Ï§Ñ Í∑∏Î£π Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏:', updated);
      return updated;
    });
    setSelectedLines([]);
    setNewGroupName('');
    setShowGroupDialog(false);
  };

  const toggleGroupVisibility = (groupId: string) => {
    setLineGroups(prev => 
      prev.map(group => 
        group.id === groupId 
          ? { ...group, isVisible: !group.isVisible }
          : group
      )
    );
  };

  const toggleGroupCollapse = (groupId: string) => {
    setLineGroups(prev => 
      prev.map(group => 
        group.id === groupId 
          ? { ...group, isCollapsed: !group.isCollapsed }
          : group
      )
    );
  };

  const deleteLineGroup = (groupId: string) => {
    setLineGroups(prev => prev.filter(group => group.id !== groupId));
  };

  // Í∑∏Î£π Ïù¥Î¶Ñ Ìé∏Ïßë ÏãúÏûë
  const startEditingGroupName = (groupId: string, currentName: string) => {
    setEditingGroupId(groupId);
    setEditingGroupName(currentName);
  };

  // Í∑∏Î£π Ïù¥Î¶Ñ Ìé∏Ïßë ÏôÑÎ£å
  const finishEditingGroupName = () => {
    if (editingGroupId && editingGroupName.trim()) {
      setLineGroups(prev => prev.map(group => 
        group.id === editingGroupId 
          ? { ...group, name: editingGroupName.trim() }
          : group
      ));
    }
    setEditingGroupId(null);
    setEditingGroupName('');
  };

  // Í∑∏Î£π Ïù¥Î¶Ñ Ìé∏Ïßë Ï∑®ÏÜå
  const cancelEditingGroupName = () => {
    setEditingGroupId(null);
    setEditingGroupName('');
  };

  const getVisibleLines = () => {
    if (showAllLines) {
      return Array.from({ length: text.split('\n').length }, (_, i) => i);
    }
    
    const visibleLines = new Set<number>();
    lineGroups.forEach(group => {
      if (group.isVisible) {
        group.lines.forEach(line => visibleLines.add(line));
      }
    });
    
    return Array.from(visibleLines).sort((a, b) => a - b);
  };

  const [selectedRegionId, setSelectedRegionId] = useState<string | null>(null);
  const [isSelecting, setIsSelecting] = useState(false);
  const [showNewCategoryDialog, setShowNewCategoryDialog] = useState(false);
  const [newCategoryName, setNewCategoryName] = useState('');
  const [editingRegionId, setEditingRegionId] = useState<string | null>(null);
  
  // ÌÖåÏù¥Î∏î ÏòÅÏó≠ Í¥ÄÎ†® ÏÉÅÌÉú
  const [showTableCreationDialog, setShowTableCreationDialog] = useState(false);
  const [tableHeaders, setTableHeaders] = useState<string[]>(['']);
  const [tableRowCount, setTableRowCount] = useState(3);
  const [tableName, setTableName] = useState('');
  const [tableCategory, setTableCategory] = useState('default');
  const [linkingTableCell, setLinkingTableCell] = useState<{tableId: string, rowIndex: number, cellIndex: number} | null>(null);
  
  // ÏÉà ÏòÅÏó≠ ÏÑ§Ï†ï Í¥ÄÎ†® ÏÉÅÌÉú
  const [showRegionSetupDialog, setShowRegionSetupDialog] = useState(false);
  const [tempRegion, setTempRegion] = useState<TextRegion | null>(null);
  const [tempRegionName, setTempRegionName] = useState('');
  const [tempSelectedCategoryId, setTempSelectedCategoryId] = useState('default');
  const [tempNewCategoryName, setTempNewCategoryName] = useState('');
  
  const textAreaRef = useRef<HTMLTextAreaElement>(null);

  // ÌÖçÏä§Ìä∏ ÏòÅÏó≠ ÏÑ†ÌÉù Ï≤òÎ¶¨ (ÎßàÏö∞Ïä§ Î∞è ÌÑ∞Ïπò ÏßÄÏõê)
  const handleTextSelection = () => {
    if (!textAreaRef.current || !isSelecting) return;
    
    const textArea = textAreaRef.current;
    const start = textArea.selectionStart;
    const end = textArea.selectionEnd;
    
    if (start === end) return; // ÏÑ†ÌÉùÎêú ÌÖçÏä§Ìä∏Í∞Ä ÏóÜÏùå
    
    const selectedText = text.substring(start, end);
    const lines = text.substring(0, start).split('\n');
    const startLine = lines.length - 1;
    const startChar = lines[lines.length - 1].length;
    
    const endLines = text.substring(0, end).split('\n');
    const endLine = endLines.length - 1;
    const endChar = endLines[endLines.length - 1].length;
    
    // ÌÖåÏù¥Î∏î ÏÖÄÍ≥º Ïó∞Îèô Ï§ëÏù∏ Í≤ΩÏö∞
    if (linkingTableCell) {
      linkTextToTableCell(selectedText, startLine, startChar, endLine, endChar);
      return;
    }
    
    // ÏûÑÏãú ÏòÅÏó≠ ÏÉùÏÑ±ÌïòÍ≥† ÏÑ§Ï†ï Îã§Ïù¥ÏñºÎ°úÍ∑∏ Ïó¥Í∏∞
    const newRegion: TextRegion = {
      id: Date.now().toString(),
      name: '',
      startLine,
      startChar,
      endLine,
      endChar,
      originalValue: selectedText,
      modifiedValue: selectedText,
      categoryId: 'default'
    };
    
    setTempRegion(newRegion);
    setTempRegionName('');
    setTempSelectedCategoryId('default');
    setTempNewCategoryName('');
    setShowRegionSetupDialog(true);
    setIsSelecting(false);
  };

  // ÏòÅÏó≠ Í∞í ÏàòÏ†ï Ïãú ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
  const updateRegionValue = (regionId: string, newValue: string) => {
    const region = regions.find(r => r.id === regionId);
    if (!region) return;
    
    // ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    const lines = text.split('\n');
    const beforeText = lines.slice(0, region.startLine).join('\n') + 
                      (region.startLine > 0 ? '\n' : '') +
                      lines[region.startLine].substring(0, region.startChar);
    const afterText = lines[region.endLine].substring(region.endChar) +
                     (region.endLine < lines.length - 1 ? '\n' : '') +
                     lines.slice(region.endLine + 1).join('\n');
    
    const newText = beforeText + newValue + afterText;
    onTextChange(newText);
    
    // ÏòÅÏó≠ ÏóÖÎç∞Ïù¥Ìä∏
    setRegions(prev => prev.map(r => 
      r.id === regionId ? { ...r, modifiedValue: newValue } : r
    ));
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉùÏÑ±
  const createCategory = () => {
    if (!newCategoryName.trim()) return;
    
    const newCategory: Category = {
      id: Date.now().toString(),
      name: newCategoryName.trim(),
      color: COLORS[categories.length % COLORS.length],
      isCollapsed: false,
      order: categories.length
    };
    
    setCategories(prev => [...prev, newCategory]);
    setNewCategoryName('');
    setShowNewCategoryDialog(false);
  };

  // ÏòÅÏó≠ ÏÑ§Ï†ï ÏôÑÎ£å
  const confirmRegionSetup = () => {
    if (!tempRegion) return;

    let categoryId = tempSelectedCategoryId;
    let regionName = tempRegionName.trim();

    // Ïù¥Î¶ÑÏù¥ ÎπÑÏñ¥ÏûàÏúºÎ©¥ Í∏∞Î≥∏ Ïù¥Î¶Ñ ÏÉùÏÑ±
    if (!regionName) {
      regionName = `ÏòÅÏó≠ ${regions.length + 1}`;
    }

    // ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÉùÏÑ±ÌïòÎäî Í≤ΩÏö∞
    if (tempSelectedCategoryId === 'new' && tempNewCategoryName.trim()) {
      const newCategory: Category = {
        id: `category_${categories.length + 1}`,
        name: tempNewCategoryName.trim(),
        color: COLORS[categories.length % COLORS.length],
        isCollapsed: false,
        order: categories.length
      };
      
      setCategories(prev => [...prev, newCategory]);
      categoryId = newCategory.id;
    }

    // ÏòÅÏó≠ Ï∂îÍ∞Ä
    const finalRegion: TextRegion = {
      ...tempRegion,
      name: regionName,
      categoryId
    };

    console.log(`üéØ [REGION DEBUG] ÏÉà ÏòÅÏó≠ Ï∂îÍ∞Ä:`, finalRegion);
    setRegions(prev => {
      const newRegions = [...prev, finalRegion];
      console.log(`üéØ [REGION DEBUG] ÏóÖÎç∞Ïù¥Ìä∏Îêú ÏòÅÏó≠ Î™©Î°ù:`, newRegions);
      return newRegions;
    });
    
    // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
    setTempRegion(null);
    setTempRegionName('');
    setTempSelectedCategoryId('default');
    setTempNewCategoryName('');
    setShowRegionSetupDialog(false);
  };

  // ÏòÅÏó≠ ÏÑ§Ï†ï Ï∑®ÏÜå
  const cancelRegionSetup = () => {
    setTempRegion(null);
    setTempRegionName('');
    setTempSelectedCategoryId('default');
    setTempNewCategoryName('');
    setShowRegionSetupDialog(false);
  };

  // ÏòÅÏó≠ÏùÑ Îã§Î•∏ Ïπ¥ÌÖåÍ≥†Î¶¨Î°ú Ïù¥Îèô
  const moveRegionToCategory = (regionId: string, categoryId: string) => {
    setRegions(prev => prev.map(r => 
      r.id === regionId ? { ...r, categoryId } : r
    ));
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥ÑÎ°ú ÏòÅÏó≠ Í∑∏Î£πÌôî
  const getRegionsByCategory = () => {
    const grouped: { [key: string]: TextRegion[] } = {};
    categories.forEach(cat => {
      grouped[cat.id] = regions.filter(r => r.categoryId === cat.id);
    });
    return grouped;
  };

  // Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÜ†Í∏Ä
  const toggleCategory = (categoryId: string) => {
    setCategories(prev => prev.map(cat => 
      cat.id === categoryId ? { ...cat, isCollapsed: !cat.isCollapsed } : cat
    ));
  };

  // ÏòÅÏó≠ ÏÇ≠Ï†ú
  const deleteRegion = (regionId: string) => {
    setRegions(prev => prev.filter(r => r.id !== regionId));
  };

  // ÌÖçÏä§Ìä∏Î•º ÌÖåÏù¥Î∏î ÏÖÄÍ≥º Ïó∞ÎèôÌïòÎäî Ìï®Ïàò
  const linkTextToTableCell = (selectedText: string, startLine: number, startChar: number, endLine: number, endChar: number) => {
    if (!linkingTableCell) return;
    
    const { tableId, rowIndex, cellIndex } = linkingTableCell;
    
    setRegions(prev => prev.map(region => {
      if (region.id === tableId && region.tableData) {
        const newTableData = { ...region.tableData };
        const cell = newTableData.rows[rowIndex].cells[cellIndex];
        
        // ÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        cell.value = selectedText;
        cell.startLine = startLine;
        cell.startChar = startChar;
        cell.endLine = endLine;
        cell.endChar = endChar;
        cell.originalValue = selectedText;
        cell.modifiedValue = selectedText;
        
        return { ...region, tableData: newTableData };
      }
      return region;
    }));
    
    // Ïó∞Îèô Î™®Îìú Ìï¥Ï†ú
    setLinkingTableCell(null);
    setIsSelecting(false);
    
    console.log(`ÌÖåÏù¥Î∏î ÏÖÄÍ≥º ÌÖçÏä§Ìä∏ Ïó∞Îèô ÏôÑÎ£å: "${selectedText}" -> ÌÖåÏù¥Î∏î ${tableId}, Ìñâ ${rowIndex + 1}, Ïó¥ ${cellIndex + 1}`);
  };

  // ÌÖåÏù¥Î∏î ÏÑ†ÌÉù Î™®ÎìúÏóêÏÑú ÌÖçÏä§Ìä∏ ÎìúÎûòÍ∑∏ Ï≤òÎ¶¨
  const handleTableSelectionMode = () => {
    if (!textAreaRef.current) return;
    
    const textArea = textAreaRef.current;
    const start = textArea.selectionStart;
    const end = textArea.selectionEnd;
    
    if (start === end) return; // ÏÑ†ÌÉùÎêú ÌÖçÏä§Ìä∏Í∞Ä ÏóÜÏùå
    
    const selectedText = text.substring(start, end);
    const lines = text.substring(0, start).split('\n');
    const startLine = lines.length - 1;
    const startChar = lines[lines.length - 1].length;
    
    const endLines = text.substring(0, end).split('\n');
    const endLine = endLines.length - 1;
    const endChar = endLines[endLines.length - 1].length;
    
    // ÎåÄÍ∏∞ Ï§ëÏù∏ ÏÑ†ÌÉù Ï†ïÎ≥¥ Ï†ÄÏû•
    setPendingSelection({
      startLine,
      startChar,
      endLine,
      endChar,
      selectedText
    });
  };

  const updateTextFromTableCell = (cell: TableCell, newValue: string) => {
    if (cell.startLine === undefined || cell.endLine === undefined) return;
    
    const lines = text.split('\n');
    const startPos = cell.startLine * 1 + cell.startChar;
    const endPos = cell.endLine * 1 + cell.endChar;
    
    // ÌÖçÏä§Ìä∏ ÏúÑÏπò Í≥ÑÏÇ∞
    let totalChars = 0;
    let actualStartPos = 0;
    let actualEndPos = 0;
    
    for (let i = 0; i <= Math.max(cell.startLine, cell.endLine); i++) {
      if (i === cell.startLine) {
        actualStartPos = totalChars + cell.startChar;
      }
      if (i === cell.endLine) {
        actualEndPos = totalChars + cell.endChar;
        break;
      }
      totalChars += lines[i].length + 1; // +1 for newline
    }
    
    // ÌÖçÏä§Ìä∏ ÍµêÏ≤¥
    const newText = text.substring(0, actualStartPos) + newValue + text.substring(actualEndPos);
    onTextChange(newText);
    
    console.log(`ÌÖåÏù¥Î∏îÏóêÏÑú ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏: "${cell.originalValue}" -> "${newValue}"`);
  };

  // ÌÖåÏù¥Î∏î ÏÉùÏÑ± Ìï®Ïàò
  const handleCreateTable = () => {
    console.log('ÌÖåÏù¥Î∏î ÏÉùÏÑ±:', { tableName, tableHeaders, tableRowCount, tableCategory });
    
    // Ïú†Ìö®Ìïú Ìó§ÎçîÎßå ÌïÑÌÑ∞ÎßÅ
    const validHeaders = tableHeaders.filter(h => h.trim());
    
    // ÌÖåÏù¥Î∏î Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ ÏÉùÏÑ± (Îπà ÏÖÄÎ°ú ÏãúÏûë)
    const tableRows: TableRow[] = [];
    for (let i = 0; i < tableRowCount; i++) {
      const cells: TableCell[] = validHeaders.map((header, colIndex) => ({
        id: `cell_${Date.now()}_${i}_${colIndex}`,
        value: '',
        startLine: 0,
        startChar: 0,
        endLine: 0,
        endChar: 0,
        originalValue: '',
        modifiedValue: ''
      }));
      
      tableRows.push({
        label: `Ìñâ ${i + 1}`,
        cells
      });
    }

    // ÏÉà ÌÖåÏù¥Î∏î ÏòÅÏó≠ ÏÉùÏÑ±
    const newTableRegion: TextRegion = {
      id: `table_${Date.now()}`,
      name: tableName,
      startLine: 0,
      startChar: 0,
      endLine: 0,
      endChar: 0,
      originalValue: '',
      modifiedValue: '',
      categoryId: tableCategory,
      type: 'table',
      tableData: {
        headers: validHeaders,
        rows: tableRows
      }
    };

    // ÏòÅÏó≠ Î™©Î°ùÏóê Ï∂îÍ∞Ä
    setRegions(prev => [...prev, newTableRegion]);

    // ÎåÄÌôîÏÉÅÏûê Îã´Í∏∞ Î∞è Ï¥àÍ∏∞Ìôî
    setShowTableCreationDialog(false);
    setTableName('');
    setTableHeaders(['']);
    setTableRowCount(3);
    setTableCategory('default');
    
    // ÌÖåÏù¥Î∏îÏù¥ ÏÉùÏÑ±ÎêòÎ©¥ ÏòÅÏó≠ ÏÑ†ÌÉù Î™®Îìú ÌôúÏÑ±Ìôî
    setIsSelecting(true);
  };

  const regionsByCategory = getRegionsByCategory();

  return (
    <div className="grid grid-cols-1 lg:grid-cols-1 gap-3">
      {/* ÏôºÏ™Ω: ÌÖçÏä§Ìä∏ ÏóêÎîîÌÑ∞ */}
      <div className="space-y-4">
        <div className="flex justify-between items-center">
          <h3 className="text-lg font-semibold">ÌÖçÏä§Ìä∏ Ìé∏Ïßë</h3>
          <div className="flex gap-2">
            <Button 
              variant={isSelecting ? "destructive" : "default"}
              size="sm"
              onClick={() => setIsSelecting(!isSelecting)}
            >
              {isSelecting ? "ÏÑ†ÌÉù Ï∑®ÏÜå" : "ÏòÅÏó≠ ÏÑ†ÌÉù"}
            </Button>
            
            <Button
              variant={isSelectionMode ? "default" : "outline"}
              size="sm"
              onClick={() => setIsSelectionMode(!isSelectionMode)}
              className={isSelectionMode ? "bg-blue-600 hover:bg-blue-700 text-white" : ""}
            >
              {isSelectionMode ? "üéØ ÌÖåÏù¥Î∏î Ïó∞Í≤∞ Ï§ë" : "üîó ÌÖåÏù¥Î∏î Ïó∞Í≤∞ Î™®Îìú"}
            </Button>

            <Button 
              variant={isLineSelectionMode ? "destructive" : "outline"}
              size="sm"
              onClick={() => {
                setIsLineSelectionMode(!isLineSelectionMode);
                if (!isLineSelectionMode) {
                  setSelectedLines([]);
                }
              }}
            >
              {isLineSelectionMode ? "Ï§Ñ ÏÑ†ÌÉù Ï¢ÖÎ£å" : "Ï§Ñ Í∑∏Î£πÌôî"}
            </Button>
          </div>
        </div>

        {/* Ï§Ñ Í∑∏Î£π Í¥ÄÎ¶¨ Ìå®ÎÑê */}
        {(isLineSelectionMode || lineGroups.length > 0) && (
          <Card className="bg-blue-50 border-blue-200">
            <CardHeader 
              className="pb-2 cursor-pointer hover:bg-blue-100"
              onClick={() => setIsGroupPanelCollapsed(!isGroupPanelCollapsed)}
            >
              <div className="flex items-center justify-between">
                <CardTitle className="text-sm">Ï§Ñ Í∑∏Î£π Í¥ÄÎ¶¨</CardTitle>
                <div className="flex items-center gap-2">
                  {isLineSelectionMode && (
                    <>
                      <Input
                        value={lineNumberInput}
                        onChange={(e) => setLineNumberInput(e.target.value)}
                        placeholder="Ïòà: 1,3,5 ÎòêÎäî 5-9 (Î≤îÏúÑ)"
                        className="w-48 h-8 text-xs"
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') {
                            selectLinesFromInput();
                          }
                        }}
                      />
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={selectLinesFromInput}
                        disabled={!lineNumberInput.trim()}
                        className="h-8 px-2 text-xs"
                      >
                        ÏÑ†ÌÉù
                      </Button>
                    </>
                  )}
                  {isLineSelectionMode && selectedLines.length > 0 && (
                    <Button
                      size="sm"
                      onClick={() => setShowGroupDialog(true)}
                      className="h-8"
                    >
                      Í∑∏Î£π ÏÉùÏÑ± ({selectedLines.length}Ï§Ñ)
                    </Button>
                  )}
                  {lineGroups.length > 0 && (
                    <Badge variant="secondary" className="text-xs">
                      {lineGroups.length}Í∞ú Í∑∏Î£π
                    </Badge>
                  )}
                  {isGroupPanelCollapsed ? (
                    <ChevronRight className="h-4 w-4" />
                  ) : (
                    <ChevronDown className="h-4 w-4" />
                  )}
                </div>
              </div>
            </CardHeader>
            {!isGroupPanelCollapsed && (
              <CardContent className="space-y-3">
                {/* Ï†ÑÏ≤¥ Î≥¥Í∏∞ Ïª®Ìä∏Î°§ */}
                <div className="flex items-center gap-3">
                  <label className="flex items-center gap-2 text-sm font-medium">
                    <input
                      type="checkbox"
                      checked={showAllLines}
                      onChange={(e) => setShowAllLines(e.target.checked)}
                      className="rounded border-gray-300"
                    />
                    Ï†ÑÏ≤¥ Î≥¥Í∏∞
                  </label>
                  
                  {/* Ï†ÑÏ≤¥ Í∑∏Î£π Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Ïª®Ìä∏Î°§ */}
                  {lineGroups.length > 0 && (
                <div className="flex items-center gap-2">
                  <Button
                    size="sm"
                    variant="ghost"
                    onClick={() => {
                      const allCollapsed = lineGroups.every(group => group.isCollapsed);
                      setLineGroups(prev => prev.map(group => ({
                        ...group,
                        isCollapsed: !allCollapsed
                      })));
                    }}
                    className="h-6 w-6 p-0"
                  >
                    {lineGroups.every(group => group.isCollapsed) ? (
                      <ChevronRight className="h-3 w-3" />
                    ) : (
                      <ChevronDown className="h-3 w-3" />
                    )}
                  </Button>
                </div>
                  )}
                  
                  
                </div>

                {/* Í∏∞Ï°¥ Í∑∏Î£πÎì§ */}
                {lineGroups.length > 0 && (
                  <div className="space-y-2">
                    {lineGroups.map(group => (
                      <div key={group.id} className="bg-white rounded border">
                        <div className="flex items-center gap-2 p-2">
                          <input
                            type="checkbox"
                            checked={group.isVisible}
                            onChange={() => toggleGroupVisibility(group.id)}
                            disabled={showAllLines}
                            className="rounded border-gray-300"
                          />
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => toggleGroupCollapse(group.id)}
                            className="h-6 w-6 p-0"
                          >
                            {group.isCollapsed ? (
                              <ChevronRight className="h-3 w-3" />
                            ) : (
                              <ChevronDown className="h-3 w-3" />
                            )}
                          </Button>
                          <div 
                            className="w-3 h-3 rounded-full"
                            style={{ backgroundColor: group.color }}
                          />
                          {editingGroupId === group.id ? (
                            <input
                              type="text"
                              value={editingGroupName}
                              onChange={(e) => setEditingGroupName(e.target.value)}
                              onBlur={finishEditingGroupName}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                  finishEditingGroupName();
                                } else if (e.key === 'Escape') {
                                  cancelEditingGroupName();
                                }
                              }}
                              className="text-sm font-medium flex-1 bg-white border rounded px-1 py-0 focus:outline-none focus:ring-1 focus:ring-blue-500"
                              autoFocus
                            />
                          ) : (
                            <span 
                              className="text-sm font-medium flex-1 cursor-pointer hover:bg-gray-100 rounded px-1 py-0"
                              onClick={() => startEditingGroupName(group.id, group.name)}
                              title="ÌÅ¥Î¶≠ÌïòÏó¨ Í∑∏Î£π Ïù¥Î¶Ñ Ìé∏Ïßë"
                            >
                              {group.name}
                            </span>
                          )}
                          <Badge variant="outline" className="text-xs">
                            {group.lines.length}Ï§Ñ
                          </Badge>
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => deleteLineGroup(group.id)}
                            className="h-6 w-6 p-0"
                          >
                            <Trash2 className="h-3 w-3" />
                          </Button>
                        </div>
                        {!group.isCollapsed && (
                          <div className="px-2 pb-2">
                            <div className="text-xs text-gray-500 bg-gray-50 p-2 rounded">
                              Ï§Ñ Î≤àÌò∏: {group.lines.map(line => line + 1).join(', ')}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {isLineSelectionMode && (
                  <div className="text-xs text-gray-600 bg-white p-2 rounded">
                    Ctrl+ÌÅ¥Î¶≠ÏúºÎ°ú Í∞úÎ≥Ñ Ï§Ñ ÏÑ†ÌÉù Î∞è Ìï¥Ï†ú || Shift+ÌÅ¥Î¶≠ÏúºÎ°ú Î≤îÏúÑ ÏÑ†ÌÉù
                    {selectedLines.length > 0 && (
                      <div className="mt-1 font-medium">
                        ÏÑ†ÌÉùÎêú Ï§Ñ: {selectedLines.map(line => line + 1).join(', ')}
                      </div>
                    )}
                  </div>
                )}
              </CardContent>
            )}
          </Card>
        )}
        
        <div className="relative">
          {isLineSelectionMode ? (
            // Ï§Ñ ÏÑ†ÌÉù Î™®ÎìúÏùº Îïå ÌÖåÏù¥Î∏î ÌòïÌÉúÎ°ú ÌëúÏãú
            <div className="border rounded-lg overflow-hidden">
              <div className="h-96 overflow-y-auto">
                <table className="w-full font-mono text-sm">
                  <tbody>
                    {text.split('\n')
                      .map((line, lineIndex) => {
                        // Ï§Ñ Í∑∏Î£π ÌïÑÌÑ∞ÎßÅ Ï†ÅÏö©
                        const isVisible = showAllLines || getVisibleLines().includes(lineIndex);
                        if (!showAllLines && !isVisible) return null;
                        
                        return (
                          <tr
                            key={lineIndex}
                            className={cn(
                              "border-b border-gray-100",
                              selectedLines.includes(lineIndex) ? "bg-blue-100" : "",
                              !isVisible ? "opacity-30" : ""
                            )}
                          >
                            {/* Ï§Ñ Î≤àÌò∏ ÏÖÄ */}
                            <td
                              className={cn(
                                "bg-white px-3 py-0 text-xs cursor-pointer hover:bg-gray-50 min-w-[50px] text-center align-middle",
                                selectedLines.includes(lineIndex) ? "text-blue-600 font-bold" : "text-gray-300"
                              )}
                              onClick={(e) => {
                                if (e.ctrlKey || e.metaKey) {
                                  toggleLineSelection(lineIndex);
                                } else if (e.shiftKey && selectedLines.length > 0) {
                                  const lastSelected = selectedLines[selectedLines.length - 1];
                                  const start = Math.min(lastSelected, lineIndex);
                                  const end = Math.max(lastSelected, lineIndex);
                                  const rangeLines: number[] = [];
                                  for (let i = start; i <= end; i++) {
                                    rangeLines.push(i);
                                  }
                                  setSelectedLines(prev => {
                                    const newSelection = new Set([...prev, ...rangeLines]);
                                    return Array.from(newSelection).sort((a, b) => a - b);
                                  });
                                } else {
                                  setSelectedLines([lineIndex]);
                                }
                              }}
                            >
                              {lineIndex + 1}
                            </td>
                            
                            {/* ÌÖçÏä§Ìä∏ ÏÖÄ */}
                            <td className="p-1 w-full">
                              <div 
                                className={cn(
                                  "bg-white outline-none min-h-[20px] leading-1 whitespace-pre-wrap break-words",
                                  "cursor-text select-text bg-gray-50 text-gray-600"
                                )}
                              >
                                {line}
                              </div>
                            </td>
                          </tr>
                        );
                      })
                      .filter(Boolean)}
                  </tbody>
                </table>
              </div>
            </div>
          ) : (
            // ÏùºÎ∞ò Î™®ÎìúÏùº Îïå Í∏∞Ï°¥ ÌÖçÏä§Ìä∏ ÏòÅÏó≠
            <div className="relative">
              <textarea
                ref={textAreaRef}
                value={showAllLines ? text : text.split('\n').filter((_, index) => getVisibleLines().includes(index)).join('\n')}
                onChange={(e) => onTextChange(e.target.value)}
                onMouseUp={isSelectionMode ? handleTableSelectionMode : handleTextSelection}
                onTouchEnd={isSelectionMode ? handleTableSelectionMode : handleTextSelection}
                className={cn(
                  "w-full h-96 p-4 font-mono text-sm border rounded-lg resize-none",
                  isSelecting ? "cursor-crosshair bg-blue-50 select-text" : "bg-white"
                )}
                placeholder="ÌÖçÏä§Ìä∏Î•º ÏûÖÎ†•ÌïòÍ≥† ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏòÅÏó≠ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî..."
              />
              {isSelecting && (
                <div className="absolute top-2 right-2 bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                  ÎìúÎûòÍ∑∏ÌïòÏó¨ ÏòÅÏó≠ ÏÑ†ÌÉù
                </div>
              )}
            </div>
          )}
        </div>
      </div>

      {/* Ïò§Î•∏Ï™Ω: ÏòÅÏó≠ Í¥ÄÎ¶¨ */}
      <div className="space-y-4">
        <div className="flex justify-between items-center">
          <h3 className="text-lg font-semibold">ÏòÅÏó≠ Í¥ÄÎ¶¨</h3>
          <div className="flex gap-2">
            <Button size="sm" onClick={() => setShowTableCreationDialog(true)}>
              <Grid className="h-4 w-4 mr-2" />
              ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            </Button>
            <Button size="sm" onClick={() => setShowNewCategoryDialog(true)}>
              <FolderPlus className="h-4 w-4 mr-2" />
              Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä
            </Button>
          </div>
        </div>

        <div className="space-y-2 max-h-96 overflow-y-auto">
          {categories.map(category => (
            <Card key={category.id} className="overflow-hidden">
              <CardHeader 
                className="pb-2 cursor-pointer hover:bg-gray-50"
                onClick={() => toggleCategory(category.id)}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    {category.isCollapsed ? (
                      <ChevronRight className="h-4 w-4" />
                    ) : (
                      <ChevronDown className="h-4 w-4" />
                    )}
                    <div 
                      className="w-3 h-3 rounded-full"
                      style={{ backgroundColor: category.color }}
                    />
                    <CardTitle className="text-sm">{category.name}</CardTitle>
                    <Badge variant="secondary" className="text-xs">
                      {regionsByCategory[category.id]?.length || 0}
                    </Badge>
                  </div>
                </div>
              </CardHeader>

              {!category.isCollapsed && (
                <CardContent className="pt-0">
                  <div className="space-y-2">
                    {regionsByCategory[category.id]?.map(region => (
                      <div 
                        key={region.id}
                        className="flex items-center gap-2 p-2 border rounded hover:bg-gray-50"
                      >
                        
                        
                        <div className="flex-1 min-w-0">
                          {region.type === 'table' ? (
                            // ÌÖåÏù¥Î∏î ÏòÅÏó≠ ÌëúÏãú
                            <div className="space-y-2">
                              <div className="flex items-center gap-2">
                                <Grid className="h-4 w-4 text-blue-600" />
                                <span className="font-medium text-blue-600">{region.name}</span>
                                <Badge variant="secondary" className="text-xs">ÌÖåÏù¥Î∏î</Badge>
                              </div> 
                              {region.tableData && (
                                <div className="bg-gray-50 rounded p-1 text-xs overflow-x-auto">
                                  <table className="border-collapse">
                                    <thead>
                                      <tr>
                                        <th className="sticky left-0 border border-gray-300 px-2 py-0.5 bg-gray-100 text-left text-xs font-medium min-w-[71px]">Ìñâ</th>
                                        {region.tableData.headers.map((header, index) => (
                                          <th key={index} className="border border-gray-300 px-1 py-0.5 bg-gray-100 text-left text-xs font-medium min-w-[88px]">
                                            <Input
                                              value={header}
                                              onChange={(e) => {
                                                setRegions(prev => prev.map(r => {
                                                  if (r.id === region.id && r.tableData) {
                                                    const newTableData = { ...r.tableData };
                                                    newTableData.headers[index] = e.target.value;
                                                    return { ...r, tableData: newTableData };
                                                  }
                                                  return r;
                                                }));
                                              }}
                                              className="h-5 text-xs border-0 p-1 bg-transparent font-medium"
                                              placeholder={`Ìó§Îçî ${index + 1}`}
                                            />
                                          </th>
                                        ))}
                                        <th className="border border-gray-300 px-1 py-0.5 bg-gray-100 text-center">
                                          <Button
                                            onClick={() => {
                                              setRegions(prev => prev.map(r => {
                                                if (r.id === region.id && r.tableData) {
                                                  const newTableData = { ...r.tableData };
                                                  newTableData.headers.push(`Ïª¨Îüº ${newTableData.headers.length + 1}`);
                                                  // Î™®Îì† ÌñâÏóê ÏÉà ÏÖÄ Ï∂îÍ∞Ä
                                                  newTableData.rows.forEach((row, rowIdx) => {
                                                    row.cells.push({
                                                      id: `cell_${region.id}_${rowIdx}_${newTableData.headers.length - 1}`,
                                                      value: '',
                                                      startLine: 0,
                                                      startChar: 0,
                                                      endLine: 0,
                                                      endChar: 0,
                                                      originalValue: '',
                                                      modifiedValue: ''
                                                    });
                                                  });
                                                  return { ...r, tableData: newTableData };
                                                }
                                                return r;
                                              }));
                                            }}
                                            size="sm"
                                            variant="ghost"
                                            className="h-4 w-4 p-0"
                                          >
                                            +
                                          </Button>
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      {region.tableData.rows.map((row, rowIndex) => (
                                        <tr key={rowIndex}>
                                          <td className="sticky left-0 border border-gray-300 px-1 py-0.5 text-xs font-medium bg-gray-50">
                                            <Input
                                              value={row.label}
                                              onChange={(e) => {
                                                setRegions(prev => prev.map(r => {
                                                  if (r.id === region.id && r.tableData) {
                                                    const newTableData = { ...r.tableData };
                                                    newTableData.rows[rowIndex].label = e.target.value;
                                                    return { ...r, tableData: newTableData };
                                                  }
                                                  return r;
                                                }));
                                              }}
                                              className="h-5 text-xs border-0 p-1 bg-transparent font-medium"
                                              placeholder={`Ìñâ ${rowIndex + 1}`}
                                            />
                                          </td>
                                          {row.cells.map((cell, cellIndex) => (
                                            <td key={cellIndex} className="border border-gray-300 px-1 py-0.5 text-xs">
                                              <div className="flex items-center gap-1">
                                                <Input
                                                  value={cell.value}
                                                  onChange={(e) => {
                                                    setRegions(prev => prev.map(r => {
                                                      if (r.id === region.id && r.tableData) {
                                                        const newTableData = { ...r.tableData };
                                                        newTableData.rows[rowIndex].cells[cellIndex].value = e.target.value;
                                                        newTableData.rows[rowIndex].cells[cellIndex].modifiedValue = e.target.value;
                                                        
                                                        // ÌÖçÏä§Ìä∏ ÏòÅÏó≠Í≥º Ïó∞Í≤∞Îêú Í≤ΩÏö∞ ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                                                        if (cell.startLine !== undefined && cell.endLine !== undefined) {
                                                          updateTextFromTableCell(cell, e.target.value);
                                                        }
                                                        
                                                        return { ...r, tableData: newTableData };
                                                      }
                                                      return r;
                                                    }));
                                                  }}
                                                  className="h-6 text-xs border-0 p-1 bg-transparent flex-1"
                                                  placeholder="-"
                                                />
                                                <Button
                                                  size="sm"
                                                  variant={linkingTableCell?.tableId === region.id && 
                                                          linkingTableCell?.rowIndex === rowIndex && 
                                                          linkingTableCell?.cellIndex === cellIndex ? "destructive" : "outline"}
                                                  onClick={() => {
                                                    if (linkingTableCell?.tableId === region.id && 
                                                        linkingTableCell?.rowIndex === rowIndex && 
                                                        linkingTableCell?.cellIndex === cellIndex) {
                                                      // Ïó∞Í≤∞ Ï∑®ÏÜå
                                                      setLinkingTableCell(null);
                                                      setIsSelecting(false);
                                                    } else {
                                                      // Ïó∞Í≤∞ ÏãúÏûë
                                                      setLinkingTableCell({ tableId: region.id, rowIndex, cellIndex });
                                                      setIsSelecting(true);
                                                    }
                                                  }}
                                                  className="h-5 w-5 p-0"
                                                >
                                                  <MapPin className="h-3 w-3" />
                                                </Button>
                                              </div>
                                            </td>
                                          ))}
                                        </tr>
                                      ))}
                                      <tr>
                                        <td className="border border-gray-300 px-1 py-0.5 bg-gray-100 text-center">
                                          <Button
                                            onClick={() => {
                                              setRegions(prev => prev.map(r => {
                                                if (r.id === region.id && r.tableData) {
                                                  const newTableData = { ...r.tableData };
                                                  const newRowIndex = newTableData.rows.length;
                                                  const newRow = {
                                                    label: `Ìñâ ${newRowIndex + 1}`,
                                                    cells: newTableData.headers.map((_, cellIndex) => ({
                                                      id: `cell_${region.id}_${newRowIndex}_${cellIndex}`,
                                                      value: '',
                                                      startLine: 0,
                                                      startChar: 0,
                                                      endLine: 0,
                                                      endChar: 0,
                                                      originalValue: '',
                                                      modifiedValue: ''
                                                    }))
                                                  };
                                                  newTableData.rows.push(newRow);
                                                  return { ...r, tableData: newTableData };
                                                }
                                                return r;
                                              }));
                                            }}
                                            size="sm"
                                            variant="ghost"
                                            className="h-4 w-4 p-0"
                                          >
                                            +
                                          </Button>
                                        </td>
                                        {region.tableData.headers.map((_, index) => (
                                          <td key={index} className="border border-gray-300 px-1 py-0.5 bg-gray-100"></td>
                                        ))}
                                        <td className="border border-gray-300 px-1 py-0.5 bg-gray-100"></td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                              )}
                            </div>
                          ) : editingRegionId === region.id ? (
                            <Input
                              value={region.name}
                              onChange={(e) => {
                                setRegions(prev => prev.map(r => 
                                  r.id === region.id ? { ...r, name: e.target.value } : r
                                ));
                              }}
                              onBlur={() => setEditingRegionId(null)}
                              onKeyDown={(e) => {
                                if (e.key === 'Enter') setEditingRegionId(null);
                              }}
                              autoFocus
                              className="text-sm"
                            />
                          ) : (
                            <div 
                              className="font-medium text-sm cursor-pointer"
                              onClick={() => setEditingRegionId(region.id)}
                            >
                              {region.name}
                            </div>
                          )}
                          
                          <div className="text-xs text-gray-500 mt-1">
                            {region.startLine}:{region.startChar} - {region.endLine}:{region.endChar}
                          </div>
                        </div>

                        <div className="flex items-center gap-1">
                          {region.type !== 'table' && (
                            <Input
                              value={region.modifiedValue}
                              onChange={(e) => updateRegionValue(region.id, e.target.value)}
                              className="text-xs min-w-0 flex-1"
                              style={{ 
                                width: `${Math.max(region.modifiedValue.length * 8 + 16, 100)}px`
                              }}
                            />
                          )}
                          
                          <Button
                            size="sm"
                            variant="ghost"
                            onClick={() => deleteRegion(region.id)}
                          >
                            <Trash2 className="h-3 w-3" />
                          </Button>
                        </div>
                      </div>
                    ))}
                    
                    {(!regionsByCategory[category.id] || regionsByCategory[category.id].length === 0) && (
                      <div className="text-sm text-gray-500 text-center py-4">
                        Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨ÏóêÎäî ÏòÅÏó≠Ïù¥ ÏóÜÏäµÎãàÎã§
                      </div>
                    )}
                  </div>
                </CardContent>
              )}
            </Card>
          ))}
        </div>
      </div>

      {/* ÏòÅÏó≠ ÏÑ§Ï†ï Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      <Dialog open={showRegionSetupDialog} onOpenChange={setShowRegionSetupDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>ÏÉà ÏòÅÏó≠ ÏÑ§Ï†ï</DialogTitle>
            <DialogDescription>
              ÏÑ†ÌÉùÌïú ÏòÅÏó≠Ïùò Ïù¥Î¶ÑÍ≥º Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label className="text-sm font-medium">ÏòÅÏó≠ Ïù¥Î¶Ñ</label>
              <Input
                value={tempRegionName}
                onChange={(e) => setTempRegionName(e.target.value)}
                placeholder="ÏòÅÏó≠ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÎπÑÏõåÎëêÎ©¥ ÏûêÎèô ÏÉùÏÑ±)"
                autoFocus
                onFocus={(e) => e.target.select()}
              />
            </div>
            
            <div>
              <label className="text-sm font-medium">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
              <Select value={tempSelectedCategoryId} onValueChange={setTempSelectedCategoryId}>
                <SelectTrigger>
                  <SelectValue placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî" />
                </SelectTrigger>
                <SelectContent>
                  {categories.map(category => (
                    <SelectItem key={category.id} value={category.id}>
                      <div className="flex items-center gap-2">
                        <div 
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: category.color }}
                        />
                        {category.name}
                      </div>
                    </SelectItem>
                  ))}
                  <SelectItem value="new">+ ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ ÎßåÎì§Í∏∞</SelectItem>
                </SelectContent>
              </Select>
            </div>

            {tempSelectedCategoryId === 'new' && (
              <div>
                <label className="text-sm font-medium">ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ</label>
                <Input
                  value={tempNewCategoryName}
                  onChange={(e) => setTempNewCategoryName(e.target.value)}
                  placeholder="ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                />
              </div>
            )}

            {tempRegion && (
              <div className="p-3 bg-gray-50 rounded border">
                <div className="text-sm text-gray-600 mb-2">ÏÑ†ÌÉùÎêú ÌÖçÏä§Ìä∏:</div>
                <div className="font-mono text-sm bg-white p-2 rounded border max-h-20 overflow-y-auto">
                  {tempRegion.originalValue}
                </div>
                <div className="text-xs text-gray-500 mt-1">
                  ÏúÑÏπò: {tempRegion.startLine}:{tempRegion.startChar} - {tempRegion.endLine}:{tempRegion.endChar}
                </div>
              </div>
            )}
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={cancelRegionSetup}>
              Ï∑®ÏÜå
            </Button>
            <Button 
              onClick={confirmRegionSetup} 
              disabled={
                tempSelectedCategoryId === 'new' && !tempNewCategoryName.trim()
              }
            >
              ÌôïÏù∏
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉùÏÑ± Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      <Dialog open={showNewCategoryDialog} onOpenChange={setShowNewCategoryDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨ ÎßåÎì§Í∏∞</DialogTitle>
            <DialogDescription>
              ÏÉàÎ°úÏö¥ Ïπ¥ÌÖåÍ≥†Î¶¨Î•º ÏÉùÏÑ±Ìï©ÎãàÎã§.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label className="text-sm font-medium">Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ</label>
              <Input
                value={newCategoryName}
                onChange={(e) => setNewCategoryName(e.target.value)}
                placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                onKeyDown={(e) => {
                  if (e.key === 'Enter') createCategory();
                }}
              />
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setShowNewCategoryDialog(false)}>
              Ï∑®ÏÜå
            </Button>
            <Button onClick={createCategory} disabled={!newCategoryName.trim()}>
              ÏÉùÏÑ±
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* ÌÖåÏù¥Î∏î ÏòÅÏó≠ ÏÉùÏÑ± ÎåÄÌôîÏÉÅÏûê */}
      <Dialog open={showTableCreationDialog} onOpenChange={setShowTableCreationDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>ÌÖåÏù¥Î∏î ÏòÅÏó≠ ÏÉùÏÑ±</DialogTitle>
            <DialogDescription>
              Íµ¨Ï°∞ÌôîÎêú Îç∞Ïù¥ÌÑ∞Î•º Í¥ÄÎ¶¨Ìï† ÌÖåÏù¥Î∏î ÏòÅÏó≠ÏùÑ ÏÉùÏÑ±Ìï©ÎãàÎã§.
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* ÌÖåÏù¥Î∏î Ïù¥Î¶Ñ */}
            <div>
              <label className="text-sm font-medium">ÌÖåÏù¥Î∏î Ïù¥Î¶Ñ</label>
              <Input
                value={tableName}
                onChange={(e) => setTableName(e.target.value)}
                placeholder="Ïòà: Î¨¥Í∏∞ Ïä§Ìéô, Ï∫êÎ¶≠ÌÑ∞ Ï†ïÎ≥¥"
              />
            </div>

            {/* Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù */}
            <div>
              <label className="text-sm font-medium">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
              <Select value={tableCategory} onValueChange={setTableCategory}>
                <SelectTrigger>
                  <SelectValue placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù" />
                </SelectTrigger>
                <SelectContent>
                  {categories.map(category => (
                    <SelectItem key={category.id} value={category.id}>
                      <div className="flex items-center gap-2">
                        <div 
                          className="w-3 h-3 rounded-full"
                          style={{ backgroundColor: category.color }}
                        />
                        {category.name}
                      </div>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Ïª¨Îüº Ìó§Îçî ÏÑ§Ï†ï */}
            <div>
              <label className="text-sm font-medium">Ïª¨Îüº Ìó§Îçî</label>
              <div className="space-y-2">
                {tableHeaders.map((header, index) => (
                  <div key={index} className="flex gap-2">
                    <Input
                      value={header}
                      onChange={(e) => {
                        const newHeaders = [...tableHeaders];
                        newHeaders[index] = e.target.value;
                        setTableHeaders(newHeaders);
                      }}
                      placeholder={`Ìó§Îçî ${index + 1}`}
                    />
                    {tableHeaders.length > 1 && (
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          const newHeaders = tableHeaders.filter((_, i) => i !== index);
                          setTableHeaders(newHeaders);
                        }}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                ))}
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setTableHeaders([...tableHeaders, ''])}
                >
                  <Plus className="h-4 w-4 mr-2" />
                  Ïª¨Îüº Ï∂îÍ∞Ä
                </Button>
              </div>
            </div>

            {/* Ìñâ Í∞úÏàò ÏÑ§Ï†ï */}
            <div>
              <label className="text-sm font-medium">Ìñâ Í∞úÏàò</label>
              <Input
                type="number"
                min="1"
                max="50"
                value={tableRowCount}
                onChange={(e) => setTableRowCount(Math.max(1, parseInt(e.target.value) || 1))}
              />
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => {
              setShowTableCreationDialog(false);
              setTableName('');
              setTableHeaders(['']);
              setTableRowCount(3);
              setTableCategory('default');
            }}>
              Ï∑®ÏÜå
            </Button>
            <Button 
              onClick={handleCreateTable}
              disabled={!tableName.trim() || tableHeaders.filter(h => h.trim()).length === 0}
            >
              ÏÉùÏÑ±
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* ÌÖåÏù¥Î∏î ÏÖÄ ÏÑ†ÌÉù Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      <Dialog open={!!pendingSelection} onOpenChange={() => setPendingSelection(null)}>
        <DialogContent className="max-w-4xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>ÌÖåÏù¥Î∏î ÏÖÄ ÏÑ†ÌÉù</DialogTitle>
            <DialogDescription>
              ÏÑ†ÌÉùÌïú ÌÖçÏä§Ìä∏ "{pendingSelection?.selectedText}"Î•º Ïñ¥Îäê ÌÖåÏù¥Î∏î ÏÖÄÏóê Ïó∞Í≤∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÌÖåÏù¥Î∏î ÏÉùÏÑ± ÌïÑÏöî)
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {regions.filter(region => region.type === 'table').map(table => (
              <div key={table.id} className="border rounded-lg p-4">
                <h4 className="font-medium mb-2">{table.name} ÌÖåÏù¥Î∏î</h4>
                {table.tableData && (
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse text-sm">
                      <thead>
                        <tr>
                          <th className="sticky left-0 border border-gray-300 px-2 py-1 bg-gray-100 z-20 min-w-[86px]"></th>
                          {table.tableData.headers.map((header, headerIndex) => (
                            <th key={headerIndex} className="border border-gray-300 px-2 py-1 bg-gray-100 text-left">
                              {header}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {table.tableData.rows.map((row, rowIndex) => (
                          <tr key={rowIndex}>
                            <td className="sticky left-0 border border-gray-300 px-2 py-1 bg-gray-50 font-medium z-10">
                              {row.label}
                            </td>
                            {row.cells.map((cell, cellIndex) => (
                              <td key={cellIndex} className="border border-gray-300 px-2 py-1 max-w-[156px]">
                                <Button
                                  variant="outline"
                                  size="sm"
                                  className="w-full text-left justify-start"
                                  onClick={() => {
                                    if (pendingSelection) {
                                      // ÏÖÄÏóê ÏúÑÏπò Ï†ïÎ≥¥ Ïó∞Í≤∞
                                      setRegions(prev => prev.map(r => {
                                        if (r.id === table.id && r.tableData) {
                                          const newTableData = { ...r.tableData };
                                          newTableData.rows[rowIndex].cells[cellIndex] = {
                                            ...cell,
                                            startLine: pendingSelection.startLine,
                                            startChar: pendingSelection.startChar,
                                            endLine: pendingSelection.endLine,
                                            endChar: pendingSelection.endChar,
                                            originalValue: pendingSelection.selectedText,
                                            modifiedValue: pendingSelection.selectedText,
                                            value: pendingSelection.selectedText
                                          };
                                          return { ...r, tableData: newTableData };
                                        }
                                        return r;
                                      }));
                                      
                                      setPendingSelection(null);
                                      // ÌÖåÏù¥Î∏î Ïó∞Í≤∞ Î™®ÎìúÎäî Í≥ÑÏÜç Ïú†ÏßÄ (ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÎÅå ÎïåÍπåÏßÄ)
                                    }
                                  }}
                                >
                                  {cell.value || "‚úîÔ∏è"}
                                </Button>
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            ))}
          </div>
          
          <DialogFooter>
            <Button variant="outline" onClick={() => setPendingSelection(null)}>
              Ï∑®ÏÜå
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Ï§Ñ Í∑∏Î£π ÏÉùÏÑ± Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      <Dialog open={showGroupDialog} onOpenChange={setShowGroupDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>ÏÉà Ï§Ñ Í∑∏Î£π ÏÉùÏÑ±</DialogTitle>
            <DialogDescription>
              ÏÑ†ÌÉùÌïú {selectedLines.length}Í∞ú Ï§ÑÏùÑ ÌïòÎÇòÏùò Í∑∏Î£πÏúºÎ°ú Î¨∂ÏäµÎãàÎã§.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label className="text-sm font-medium">Í∑∏Î£π Ïù¥Î¶Ñ</label>
              <Input
                value={newGroupName}
                onChange={(e) => setNewGroupName(e.target.value)}
                placeholder="Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                autoFocus
              />
            </div>
            
            <div className="p-3 bg-gray-50 rounded border">
              <div className="text-sm text-gray-600 mb-2">ÏÑ†ÌÉùÎêú Ï§Ñ:</div>
              <div className="text-sm font-mono">
                {selectedLines.map(line => line + 1).join(', ')}
              </div>
              <div className="text-xs text-gray-500 mt-2">
                Ï¥ù {selectedLines.length}Ï§ÑÏù¥ ÏÑ†ÌÉùÎêòÏóàÏäµÎãàÎã§.
              </div>
            </div>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => {
              setShowGroupDialog(false);
              setNewGroupName('');
            }}>
              Ï∑®ÏÜå
            </Button>
            <Button 
              onClick={createLineGroup}
              disabled={!newGroupName.trim()}
            >
              Í∑∏Î£π ÏÉùÏÑ±
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}