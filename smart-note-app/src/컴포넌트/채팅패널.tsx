import React, { useState, useEffect, useRef } from 'react';
import MessageBubble from './MessageBubble';
import { Supabaseμƒνƒμ‚¬μ©ν•κΈ° } from '../μƒνƒκ΄€λ¦¬/supabaseμƒνƒ';
import μΉ΄ν…κ³ λ¦¬μ…λ ¥ from './μΉ΄ν…κ³ λ¦¬μ…λ ¥';
import λ€ν™”ν•μ…λ ¥ from './λ€ν™”ν•μ…λ ¥';
import λ™μ μΉ΄ν…κ³ λ¦¬νμ—… from './λ™μ μΉ΄ν…κ³ λ¦¬νμ—…';
import { μ΅°ν•©μ΄λ¦„κ°€μ Έμ¤κΈ°, μ΅°ν•©μƒ‰μƒκ°€μ Έμ¤κΈ°, μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ €μ¥, μ €μ¥λμ΅°ν•©μ΄λ¦„ν™•μΈ } from '../μ ν‹Έ/μΉ΄ν…κ³ λ¦¬μƒ‰μƒ';
import { μ¤λ§νΈμ‹κ°„ν¬λ§·ν… } from '../μ ν‹Έ/μ‹κ°„ν‘μ‹';
import { λ…ΈνΈμ„¤μ •κ°€μ Έμ¤κΈ°, ν΄λ”κΈ°λ³Έμ„¤μ •μ‚¬μ©μ¤‘μΈμ§€ν™•μΈ } from '../μ ν‹Έ/λ…ΈνΈμ„¤μ •μ ν‹Έ';
import { μ•±μƒνƒμ‚¬μ©ν•κΈ° } from '../μƒνƒκ΄€λ¦¬/μ•±μƒνƒ';

// μ±„ν… ν¨λ„ μ»΄ν¬λ„νΈ - Supabase μ—°λ™
const μ±„ν…ν¨λ„: React.FC = () => {
  const { ν™μ„±λ…ΈνΈ, μƒλ©”μ‹μ§€μ¶”κ°€ν•κΈ°, μƒλ…ΈνΈμƒμ„±ν•κΈ°, ν™μ„±ν΄λ”, ν΄λ”μ„¤μ •μ—…λ°μ΄νΈν•κΈ° } = Supabaseμƒνƒμ‚¬μ©ν•κΈ°();
  const { μ—°μƒκ²€μƒ‰κ²°κ³Όμ„¤μ • } = μ•±μƒνƒμ‚¬μ©ν•κΈ°();
  const [ν„μ¬μ…λ ¥κ°’, ν„μ¬μ…λ ¥κ°’μ„¤μ •] = useState('');
  const [νΈμ§‘νμ—…μ—΄λ¦Ό, νΈμ§‘νμ—…μ—΄λ¦Όμ„¤μ •] = useState(false);
  const [νΈμ§‘λ€μƒλ©”μ‹μ§€μ•„μ΄λ””, νΈμ§‘λ€μƒλ©”μ‹μ§€μ•„μ΄λ””μ„¤μ •] = useState<string | null>(null);
  const [νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅, νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅μ„¤μ •] = useState<string[]>([]);
  const [ν™•μ¥λμ‹κ°„λ©λ΅, ν™•μ¥λμ‹κ°„λ©λ΅μ„¤μ •] = useState<Set<string>>(new Set()); // ν΄λ¦­ν•μ—¬ ν™•μ¥λ μ‹κ°„λ“¤
  const [ν•μ„μ…λ ¥μ—΄λ¦°λ©”μ‹μ§€λ©λ΅, ν•μ„μ…λ ¥μ—΄λ¦°λ©”μ‹μ§€λ©λ΅μ„¤μ •] = useState<Set<string>>(new Set()); // ν•μ„ μ…λ ¥μ°½μ΄ μ—΄λ¦° λ©”μ‹μ§€λ“¤
  const [ν•μ„μ…λ ¥κ°’λ©λ΅, ν•μ„μ…λ ¥κ°’λ©λ΅μ„¤μ •] = useState<{[λ©”μ‹μ§€μ•„μ΄λ””: string]: string}>({}); // κ° λ©”μ‹μ§€λ³„ ν•μ„ μ…λ ¥κ°’
  const [μ¨κΉ€λ©”μ‹μ§€λ©λ΅, μ¨κΉ€λ©”μ‹μ§€λ©λ΅μ„¤μ •] = useState<Set<string>>(new Set()); // μ¨κ²¨μ§„ λ©”μ‹μ§€λ“¤ (ν΄λ” ν†µν•©λ·° μ „μ©)
  const [μ¨κΉ€λ©”μ‹μ§€ν‘μ‹μ—¬λ¶€, μ¨κΉ€λ©”μ‹μ§€ν‘μ‹μ—¬λ¶€μ„¤μ •] = useState(false); // μ¨κΈ΄ λ©”μ‹μ§€ ν‘μ‹ ν† κΈ€ (ν΄λ” ν†µν•©λ·° μ „μ©)
  const λ©”μ‹μ§€λ©λ΅μ°Έμ΅° = useRef<HTMLDivElement>(null);

  // λ©”μ‹μ§€κ°€ μ¶”κ°€λ  λ•λ§λ‹¤ μ¤ν¬λ΅¤μ„ λ§¨ μ•„λλ΅
  useEffect(() => {
    if (λ©”μ‹μ§€λ©λ΅μ°Έμ΅°.current) {
      λ©”μ‹μ§€λ©λ΅μ°Έμ΅°.current.scrollTop = λ©”μ‹μ§€λ©λ΅μ°Έμ΅°.current.scrollHeight;
    }
  }, [ν™μ„±λ…ΈνΈ?.μ±„ν…λ©”μ‹μ§€λ©λ΅]);

  // μ‹¤μ‹κ°„ μ—°μƒ κ²€μƒ‰ (μ…λ ¥κ°’μ΄ λ³€κ²½λ  λ•λ§λ‹¤)
  useEffect(() => {
    const μ‹¤μ‹κ°„κ²€μƒ‰μ‹¤ν–‰ = async () => {
      if (ν„μ¬μ…λ ¥κ°’.trim() !== '') {
        console.log('μ‹¤μ‹κ°„ κ²€μƒ‰ μ‹λ„:', ν„μ¬μ…λ ¥κ°’); // λ””λ²„κ·Έ λ΅κ·Έ
        await μ—°μƒκ²€μƒ‰μ²λ¦¬(ν„μ¬μ…λ ¥κ°’);
      } else {
        // μ…λ ¥μ΄ λΉ„μ–΄μμΌλ©΄ κ²€μƒ‰ κ²°κ³Ό ν΄λ¦¬μ–΄
        μ—°μƒκ²€μƒ‰κ²°κ³Όμ„¤μ •(null);
      }
    };

    μ‹¤μ‹κ°„κ²€μƒ‰μ‹¤ν–‰();
  }, [ν„μ¬μ…λ ¥κ°’, ν™μ„±ν΄λ”]);

  // μ—°μƒ κ²€μƒ‰ μ²λ¦¬ ν•¨μ
  const μ—°μƒκ²€μƒ‰μ²λ¦¬ = async (μ…λ ¥ν…μ¤νΈ: string) => {
    console.log('μ—°μƒκ²€μƒ‰μ²λ¦¬ νΈμ¶λ¨:', μ…λ ¥ν…μ¤νΈ); // λ””λ²„κ·Έ λ΅κ·Έ
    
    // "ν‚¤μ›λ“-" ν¨ν„΄ κ°μ§€ (μ: "κ³ μ¶”-", "κΈ°μ–µν•΄ μ¤-")
    const μ—°μƒν¨ν„΄ = /^(.+)-\s*$/;
    const λ§¤μΉ­κ²°κ³Ό = μ…λ ¥ν…μ¤νΈ.match(μ—°μƒν¨ν„΄);
    
    console.log('ν¨ν„΄ λ§¤μΉ­ κ²°κ³Ό:', λ§¤μΉ­κ²°κ³Ό); // λ””λ²„κ·Έ λ΅κ·Έ
    
    if (λ§¤μΉ­κ²°κ³Ό && ν™μ„±ν΄λ”) {
      const κ²€μƒ‰ν‚¤μ›λ“ = λ§¤μΉ­κ²°κ³Ό[1].trim();
      console.log('κ²€μƒ‰ ν‚¤μ›λ“:', κ²€μƒ‰ν‚¤μ›λ“); // λ””λ²„κ·Έ λ΅κ·Έ
      
      // λ¨λ“  λ…ΈνΈμ—μ„ ν‚¤μ›λ“ κ²€μƒ‰
      const κ²€μƒ‰κ²°κ³Ό = ν™μ„±ν΄λ”.λ…ΈνΈλ©λ΅
        .filter(λ…ΈνΈ => 
          λ…ΈνΈ.μ λ©.includes(κ²€μƒ‰ν‚¤μ›λ“) || 
          λ…ΈνΈ.λ‚΄μ©.includes(κ²€μƒ‰ν‚¤μ›λ“) ||
          λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅.some(λ©”μ‹μ§€ => λ©”μ‹μ§€.ν…μ¤νΈ.includes(κ²€μƒ‰ν‚¤μ›λ“))
        )
        .map(λ…ΈνΈ => ({
          λ…ΈνΈμ•„μ΄λ””: λ…ΈνΈ.μ•„μ΄λ””,
          λ…ΈνΈμ λ©: λ…ΈνΈ.μ λ©,
          κ΄€λ ¨λ‚΄μ©: λ…ΈνΈ.λ‚΄μ©.includes(κ²€μƒ‰ν‚¤μ›λ“) ? λ…ΈνΈ.λ‚΄μ© : 
                   λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅.find(λ©”μ‹μ§€ => λ©”μ‹μ§€.ν…μ¤νΈ.includes(κ²€μƒ‰ν‚¤μ›λ“))?.ν…μ¤νΈ || '',
          λ§¤μΉ­νƒ€μ…: (λ…ΈνΈ.μ λ©.includes(κ²€μƒ‰ν‚¤μ›λ“) ? 'μ λ©' : 'λ‚΄μ©') as 'μ λ©' | 'λ‚΄μ©'
        }));
      
      console.log('κ²€μƒ‰ κ²°κ³Ό:', κ²€μƒ‰κ²°κ³Ό); // λ””λ²„κ·Έ λ΅κ·Έ
      
      // μ°μΈ΅ ν¨λ„μ— κ²€μƒ‰ κ²°κ³Ό μ „λ‹¬
      μ—°μƒκ²€μƒ‰κ²°κ³Όμ„¤μ •({
        κ²€μƒ‰ν‚¤μ›λ“,
        κ²€μƒ‰κ²°κ³Ό,
        κ²€μƒ‰μ‹κ°„: new Date()
      });
      
      console.log('μ—°μƒ κ²€μƒ‰ μ™„λ£, κ²°κ³Ό μ„¤μ •λ¨'); // λ””λ²„κ·Έ λ΅κ·Έ
      return true; // μ—°μƒ κ²€μƒ‰μ΄ μ²λ¦¬λ¨
    }
    
    return false; // μΌλ° λ©”μ‹μ§€
  };

  const λ©”μ‹μ§€μ „μ†΅ν•κΈ° = async (ν…μ¤νΈ: string, μµμ…?: { category?: string; author?: string; λ§ν’μ„ μ„μΉ?: 'μ™Όμ½' | 'μ¤λ¥Έμ½' }) => {
    if (ν…μ¤νΈ.trim() === '') return;
    
    // μ—°μƒ κ²€μƒ‰ ν¨ν„΄μΈμ§€ ν™•μΈ
    const μ—°μƒν¨ν„΄ = /^(.+)-\s*$/;
    const λ§¤μΉ­κ²°κ³Ό = ν…μ¤νΈ.match(μ—°μƒν¨ν„΄);
    
    if (λ§¤μΉ­κ²°κ³Ό) {
      // μ—°μƒ κ²€μƒ‰ ν¨ν„΄μ΄λ©΄ μ…λ ¥μ°½λ§ ν΄λ¦¬μ–΄ν•κ³  κ²€μƒ‰ κ²°κ³Ό μ μ§€
      ν„μ¬μ…λ ¥κ°’μ„¤μ •('');
      return;
    }
    
    try {
      // ν™μ„± λ…ΈνΈκ°€ μ—†κ³  ν™μ„± ν΄λ”κ°€ μμΌλ©΄ μƒ λ…ΈνΈ μƒμ„±
      if (!ν™μ„±λ…ΈνΈ && ν™μ„±ν΄λ”) {
        const ν„μ¬λ‚ μ§ = new Date().toLocaleDateString('ko-KR');
        const μƒλ…ΈνΈμ•„μ΄λ”” = await μƒλ…ΈνΈμƒμ„±ν•κΈ°(ν™μ„±ν΄λ”.μ•„μ΄λ””, ν„μ¬λ‚ μ§);
        // μƒ λ…ΈνΈκ°€ μƒμ„±λκ³  ν™μ„±λ…ΈνΈλ΅ μ„¤μ •λ ν›„ λ©”μ‹μ§€ μ¶”κ°€
        await μƒλ©”μ‹μ§€μ¶”κ°€ν•κΈ°(μƒλ…ΈνΈμ•„μ΄λ””, ν…μ¤νΈ.trim(), μµμ…);
        return;
      }

      // ν™μ„± λ…ΈνΈκ°€ μμΌλ©΄ λ©”μ‹μ§€ μ¶”κ°€
      if (ν™μ„±λ…ΈνΈ) {
        await μƒλ©”μ‹μ§€μ¶”κ°€ν•κΈ°(ν™μ„±λ…ΈνΈ.μ•„μ΄λ””, ν…μ¤νΈ.trim(), μµμ…);
      }
    } catch (μ¤λ¥) {
      console.error('λ©”μ‹μ§€ μ „μ†΅ μ‹¤ν¨:', μ¤λ¥);
    }
  };

  // λ‹¨μ μ±„ν…μ© λ©”μ‹μ§€ μ „μ†΅ (κΈ°μ΅΄ ν•¨μ μ μ§€)
  const λ‹¨μλ©”μ‹μ§€μ „μ†΅ν•κΈ° = async () => {
    console.log('λ‹¨μλ©”μ‹μ§€μ „μ†΅ν•κΈ° νΈμ¶λ¨:', ν„μ¬μ…λ ¥κ°’); // λ””λ²„κ·Έ λ΅κ·Έ
    await λ©”μ‹μ§€μ „μ†΅ν•κΈ°(ν„μ¬μ…λ ¥κ°’);
    // ν„μ¬μ…λ ¥κ°’μ„¤μ •('')μ€ λ©”μ‹μ§€μ „μ†΅ν•κΈ° λ‚΄λ¶€μ—μ„ μ²λ¦¬λ¨
  };

  const μ—”ν„°ν‚¤μ²λ¦¬ = (event: React.KeyboardEvent) => {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      λ‹¨μλ©”μ‹μ§€μ „μ†΅ν•κΈ°();
    }
  };

  // μΉ΄ν…κ³ λ¦¬ νΈμ§‘ νμ—… μ—΄κΈ°
  const μΉ΄ν…κ³ λ¦¬νΈμ§‘μ—΄κΈ° = (λ©”μ‹μ§€μ•„μ΄λ””: string, μΉ΄ν…κ³ λ¦¬λ©λ΅: string[]) => {
    if (!ν™μ„±μ„¤μ •?.λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ© || μΉ΄ν…κ³ λ¦¬λ©λ΅.length <= 1) {
      return; // λ™μ  μΉ΄ν…κ³ λ¦¬ λ―Έμ‚¬μ©μ΄κ±°λ‚ λ‹¨μΌ μΉ΄ν…κ³ λ¦¬λ©΄ νΈμ§‘ λ¶κ°€
    }
    
    νΈμ§‘λ€μƒλ©”μ‹μ§€μ•„μ΄λ””μ„¤μ •(λ©”μ‹μ§€μ•„μ΄λ””);
    νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅μ„¤μ •(μΉ΄ν…κ³ λ¦¬λ©λ΅);
    νΈμ§‘νμ—…μ—΄λ¦Όμ„¤μ •(true);
  };

  // μΉ΄ν…κ³ λ¦¬ νΈμ§‘ ν™•μ • μ²λ¦¬
  const μΉ΄ν…κ³ λ¦¬νΈμ§‘ν™•μ • = async (μ΅°ν•©μ΄λ¦„: string) => {
    if (!νΈμ§‘λ€μƒλ©”μ‹μ§€μ•„μ΄λ”” || !ν™μ„±ν΄λ”) return;

    try {
      // μ΅°ν•© μ΄λ¦„μ„ λ°μ΄ν„°λ² μ΄μ¤μ— μ €μ¥
      const μƒμ΅°ν•©μ„¤μ • = μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ €μ¥(νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅, μ΅°ν•©μ΄λ¦„, ν™μ„±μ„¤μ •?.μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ„¤μ •);
      await ν΄λ”μ„¤μ •μ—…λ°μ΄νΈν•κΈ°(ν™μ„±ν΄λ”.μ•„μ΄λ””, { μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ„¤μ •: μƒμ΅°ν•©μ„¤μ • });

      // νΈμ§‘ μ™„λ£ ν›„ νμ—… λ‹«κΈ°
      νΈμ§‘νμ—…λ‹«κΈ°();
    } catch (μ¤λ¥) {
      console.error('μΉ΄ν…κ³ λ¦¬ νΈμ§‘ μ‹¤ν¨:', μ¤λ¥);
    }
  };

  // μΉ΄ν…κ³ λ¦¬ νΈμ§‘ νμ—… λ‹«κΈ°
  const νΈμ§‘νμ—…λ‹«κΈ° = () => {
    νΈμ§‘νμ—…μ—΄λ¦Όμ„¤μ •(false);
    νΈμ§‘λ€μƒλ©”μ‹μ§€μ•„μ΄λ””μ„¤μ •(null);
    νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅μ„¤μ •([]);
  };

  // μ‹κ°„ ν‘μ‹ ν† κΈ€ ν•¨μ
  const μ‹κ°„ν‘μ‹ν† κΈ€ = (λ©”μ‹μ§€μ•„μ΄λ””: string) => {
    ν™•μ¥λμ‹κ°„λ©λ΅μ„¤μ •(prev => {
      const μƒλ©λ΅ = new Set(prev);
      if (μƒλ©λ΅.has(λ©”μ‹μ§€μ•„μ΄λ””)) {
        μƒλ©λ΅.delete(λ©”μ‹μ§€μ•„μ΄λ””);
      } else {
        μƒλ©λ΅.add(λ©”μ‹μ§€μ•„μ΄λ””);
      }
      return μƒλ©λ΅;
    });
  };

  // ν•μ„ μ…λ ¥μ°½ ν† κΈ€ ν•¨μ
  const ν•μ„μ…λ ¥ν† κΈ€ = (λ©”μ‹μ§€μ•„μ΄λ””: string) => {
    ν•μ„μ…λ ¥μ—΄λ¦°λ©”μ‹μ§€λ©λ΅μ„¤μ •(prev => {
      const μƒλ©λ΅ = new Set(prev);
      if (μƒλ©λ΅.has(λ©”μ‹μ§€μ•„μ΄λ””)) {
        μƒλ©λ΅.delete(λ©”μ‹μ§€μ•„μ΄λ””);
        // μ…λ ¥μ°½μ„ λ‹«μ„ λ• μ…λ ¥κ°’λ„ μ΄κΈ°ν™”
        ν•μ„μ…λ ¥κ°’λ©λ΅μ„¤μ •(prev => {
          const μƒμ…λ ¥κ°’λ©λ΅ = { ...prev };
          delete μƒμ…λ ¥κ°’λ©λ΅[λ©”μ‹μ§€μ•„μ΄λ””];
          return μƒμ…λ ¥κ°’λ©λ΅;
        });
      } else {
        μƒλ©λ΅.add(λ©”μ‹μ§€μ•„μ΄λ””);
      }
      return μƒλ©λ΅;
    });
  };

  // ν•μ„ μ…λ ¥κ°’ λ³€κ²½ ν•¨μ
  const ν•μ„μ…λ ¥κ°’λ³€κ²½ = (λ©”μ‹μ§€μ•„μ΄λ””: string, κ°’: string) => {
    ν•μ„μ…λ ¥κ°’λ©λ΅μ„¤μ •(prev => ({
      ...prev,
      [λ©”μ‹μ§€μ•„μ΄λ””]: κ°’
    }));
  };

  // ν•μ„ λ©”μ‹μ§€ μ „μ†΅ ν•¨μ
  const ν•μ„λ©”μ‹μ§€μ „μ†΅ν•κΈ° = async (λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””: string) => {
    const ν•μ„μ…λ ¥κ°’ = ν•μ„μ…λ ¥κ°’λ©λ΅[λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””];
    if (!ν•μ„μ…λ ¥κ°’ || ν•μ„μ…λ ¥κ°’.trim() === '' || !ν™μ„±λ…ΈνΈ) return;

    try {
      await μƒλ©”μ‹μ§€μ¶”κ°€ν•κΈ°(ν™μ„±λ…ΈνΈ.μ•„μ΄λ””, ν•μ„μ…λ ¥κ°’.trim(), { 
        λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””: λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ”” 
      });
      
      // μ „μ†΅ ν›„ μ…λ ¥κ°’ μ΄κΈ°ν™” λ° μ…λ ¥μ°½ λ‹«κΈ°
      ν•μ„μ…λ ¥κ°’λ©λ΅μ„¤μ •(prev => {
        const μƒμ…λ ¥κ°’λ©λ΅ = { ...prev };
        delete μƒμ…λ ¥κ°’λ©λ΅[λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””];
        return μƒμ…λ ¥κ°’λ©λ΅;
      });
      ν•μ„μ…λ ¥μ—΄λ¦°λ©”μ‹μ§€λ©λ΅μ„¤μ •(prev => {
        const μƒλ©λ΅ = new Set(prev);
        μƒλ©λ΅.delete(λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””);
        return μƒλ©λ΅;
      });
    } catch (μ¤λ¥) {
      console.error('ν•μ„ λ©”μ‹μ§€ μ „μ†΅ μ‹¤ν¨:', μ¤λ¥);
    }
  };

  // λ©”μ‹μ§€ μ¨κΉ€/ν‘μ‹ ν† κΈ€ ν•¨μ (ν΄λ” ν†µν•©λ·° μ „μ©)
  const λ©”μ‹μ§€μ¨κΉ€ν† κΈ€ = (λ©”μ‹μ§€μ•„μ΄λ””: string) => {
    μ¨κΉ€λ©”μ‹μ§€λ©λ΅μ„¤μ •(prev => {
      const μƒλ©λ΅ = new Set(prev);
      if (μƒλ©λ΅.has(λ©”μ‹μ§€μ•„μ΄λ””)) {
        μƒλ©λ΅.delete(λ©”μ‹μ§€μ•„μ΄λ””);
      } else {
        μƒλ©λ΅.add(λ©”μ‹μ§€μ•„μ΄λ””);
      }
      return μƒλ©λ΅;
    });
  };

  // μ¨κΈ΄ λ©”μ‹μ§€ ν‘μ‹ ν† κΈ€ ν•¨μ (ν΄λ” ν†µν•©λ·° μ „μ©)
  const μ¨κΈ΄λ©”μ‹μ§€ν‘μ‹ν† κΈ€ = () => {
    μ¨κΉ€λ©”μ‹μ§€ν‘μ‹μ—¬λ¶€μ„¤μ •(prev => !prev);
  };


  // ν™μ„± ν΄λ”κ°€ μ—†μΌλ©΄ ν΄λ” μ„ νƒ λ©”μ‹μ§€ ν‘μ‹
  if (!ν™μ„±ν΄λ”) {
    return (
      <div className="μ±„ν…ν¨λ„-μ»¨ν…μ΄λ„">
        <div className="μ±„ν…λ©”μ‹μ§€-λ©λ΅" style={{ 
          display: 'flex', 
          alignItems: 'center', 
          justifyContent: 'center',
          color: '#999'
        }}>
          ν΄λ”λ¥Ό μ„ νƒν•μ„Έμ”
        </div>
      </div>
    );
  }

  // ν„μ¬ ν™μ„±ν™”λ μ„¤μ • κ³„μ‚° (λ…ΈνΈλ³„ μ„¤μ • μ°μ„ , μ—†μΌλ©΄ ν΄λ” μ„¤μ •)
  const ν™μ„±μ„¤μ • = λ…ΈνΈμ„¤μ •κ°€μ Έμ¤κΈ°(ν™μ„±λ…ΈνΈ, ν™μ„±ν΄λ”.ν΄λ”μ„¤μ •);

  // ν΄λ” ν†µν•© μ±„ν…λ·° λ°μ΄ν„° μƒμ„± (ν™μ„±λ…ΈνΈκ°€ μ—†κ³  ν™μ„±ν΄λ”κ°€ μμ„ λ•)
  const ν΄λ”ν†µν•©μ±„ν…λ©λ΅ = !ν™μ„±λ…ΈνΈ && ν™μ„±ν΄λ” ? 
    ν™μ„±ν΄λ”.λ…ΈνΈλ©λ΅
      .flatMap(λ…ΈνΈ => 
        λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅.map(λ©”μ‹μ§€ => ({
          ...λ©”μ‹μ§€,
          λ…ΈνΈμ λ©: λ…ΈνΈ.μ λ©,
          λ…ΈνΈμ•„μ΄λ””: λ…ΈνΈ.μ•„μ΄λ””
        }))
      )
      .sort((a, b) => new Date(a.νƒ€μ„μ¤νƒ¬ν”„).getTime() - new Date(b.νƒ€μ„μ¤νƒ¬ν”„).getTime())
    : [];

  return (
    <div className="μ±„ν…ν¨λ„-μ»¨ν…μ΄λ„">
      {/* μ±„ν… λ©”μ‹μ§€ λ©λ΅ μμ—­ */}
      <div className="μ±„ν…λ©”μ‹μ§€-λ©λ΅" ref={λ©”μ‹μ§€λ©λ΅μ°Έμ΅°}>
        {/* κ°λ³„ λ…ΈνΈ λ·° */}
        {ν™μ„±λ…ΈνΈ && (
          ν™μ„±λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅.length === 0 ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              height: '100%',
              color: '#999',
              fontSize: '14px'
            }}>
              μ²« λ²μ§Έ λ©”μ‹μ§€λ¥Ό μ…λ ¥ν•΄λ³΄μ„Έμ”
            </div>
          ) : (
            ν™μ„±λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅.map((λ©”μ‹μ§€) => {
            // μΉ΄ν…κ³ λ¦¬ μƒ‰μƒ κ³„μ‚°
            const μΉ΄ν…κ³ λ¦¬λ©λ΅ = λ©”μ‹μ§€.μΉ΄ν…κ³ λ¦¬ ? λ©”μ‹μ§€.μΉ΄ν…κ³ λ¦¬.split(',').map(cat => cat.trim()) : [];
            const μΉ΄ν…κ³ λ¦¬μƒ‰μƒ = μΉ΄ν…κ³ λ¦¬λ©λ΅.length > 0 ? μ΅°ν•©μƒ‰μƒκ°€μ Έμ¤κΈ°(μΉ΄ν…κ³ λ¦¬λ©λ΅) : null;
            const μΉ΄ν…κ³ λ¦¬μ΄λ¦„ = μΉ΄ν…κ³ λ¦¬λ©λ΅.length > 0 ? μ΅°ν•©μ΄λ¦„κ°€μ Έμ¤κΈ°(μΉ΄ν…κ³ λ¦¬λ©λ΅, ν™μ„±μ„¤μ •.μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ„¤μ •) : '';
            
            // λ™μ  μΉ΄ν…κ³ λ¦¬ μ‚¬μ© μ—¬λ¶€μ— λ”°λ¥Έ ν‘μ‹ λ°©μ‹ κ²°μ •
            const λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ© = ν™μ„±μ„¤μ •.λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ© ?? false;
            
            let μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„°: string[] = [];
            if (λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ©) {
              // λ™μ  λ°©μ‹: μΉ΄ν…κ³ λ¦¬ μ΄λ¦„μ„ 3κΈ€μμ”© λ‚λ„μ–΄ μ„Έλ΅ ν‘μ‹
              if (μΉ΄ν…κ³ λ¦¬μ΄λ¦„ && μΉ΄ν…κ³ λ¦¬μ΄λ¦„.trim() !== '') {
                μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„° = μΉ΄ν…κ³ λ¦¬μ΄λ¦„.match(/.{1,3}/g) || [];
              }
            } else {
              // κΈ°λ³Έ λ°©μ‹: μ‰Όν‘λ΅ κµ¬λ¶„λ κ° μΉ΄ν…κ³ λ¦¬λ¥Ό μ¤„λ°”κΏμΌλ΅ ν‘μ‹  
              μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„° = μΉ΄ν…κ³ λ¦¬λ©λ΅.filter(cat => cat && cat.trim() !== '');
            }
            
            return (
              <MessageBubble 
                key={λ©”μ‹μ§€.μ•„μ΄λ””}
                λ©”μ‹μ§€={{
                  μ•„μ΄λ””: λ©”μ‹μ§€.μ•„μ΄λ””,
                  ν…μ¤νΈ: λ©”μ‹μ§€.ν…μ¤νΈ,
                  νƒ€μ„μ¤νƒ¬ν”„: λ©”μ‹μ§€.νƒ€μ„μ¤νƒ¬ν”„.toISOString(),
                  μ‘μ„±μ: λ©”μ‹μ§€.μ‘μ„±μ,
                  λ§ν’μ„ μ„μΉ: λ©”μ‹μ§€.λ§ν’μ„ μ„μΉ,
                  // μΊλ¦­ν„° μ•„μ΄μ½κ³Ό μƒ‰μƒμ€ Supabaseμ—μ„ κ°€μ Έμ¨ λ°μ΄ν„°λ¥Ό κΈ°λ°μΌλ΅ μ„¤μ •ν•΄μ•Ό ν•©λ‹λ‹¤.
                  // ν„μ¬λ” μ„μ‹ κ°’μΌλ΅ μ„¤μ •ν•©λ‹λ‹¤.
                  μΊλ¦­ν„°μ•„μ΄μ½: 'κΈ°λ³Έ',
                  λ§ν’μ„ μƒ‰μƒ: '#f0f0f0'
                }}
                μ‹κ°„ν‘μ‹μ—¬λ¶€={ν™μ„±μ„¤μ •.μ‹κ°„ν‘μ‹μ—¬λ¶€}
                onμ‹κ°„ν‘μ‹ν† κΈ€={μ‹κ°„ν‘μ‹ν† κΈ€}
                ν™•μ¥λμ‹κ°„λ©λ΅={ν™•μ¥λμ‹κ°„λ©λ΅}
                μ…λ ¥λ°©μ‹={ν™μ„±μ„¤μ •.μ…λ ¥λ°©μ‹} // π”¥ μ…λ ¥λ°©μ‹λ³„ μ•„μ΄μ½ ν‘μ‹ μ μ–΄
                μΉ΄ν…κ³ λ¦¬μ •λ³΄={μΉ΄ν…κ³ λ¦¬λ©λ΅.length > 0 ? {
                  μΉ΄ν…κ³ λ¦¬λ©λ΅,
                  μΉ΄ν…κ³ λ¦¬μƒ‰μƒ,
                  μΉ΄ν…κ³ λ¦¬μ΄λ¦„,
                  λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ©,
                  μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„°,
                  onμΉ΄ν…κ³ λ¦¬νΈμ§‘: μΉ΄ν…κ³ λ¦¬νΈμ§‘μ—΄κΈ°
                } : undefined} // π”¥ μΉ΄ν…κ³ λ¦¬ν• μ…λ ¥ μ‹μ—λ§ μΉ΄ν…κ³ λ¦¬ μ •λ³΄ μ „λ‹¬
              />
            );
          })
        ))}
        
        {/* ν΄λ” ν†µν•© μ±„ν…λ·° */}
        {!ν™μ„±λ…ΈνΈ && ν™μ„±ν΄λ” && (
          ν΄λ”ν†µν•©μ±„ν…λ©λ΅.length === 0 ? (
            <div style={{ 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              height: '100%',
              color: '#999',
              fontSize: '14px',
              textAlign: 'center',
              lineHeight: '1.6'
            }}>
              π“ {ν™μ„±ν΄λ”.μ΄λ¦„} ν΄λ” ν†µν•©λ·°<br />
              μ΄ ν΄λ”μ— λ©”μ‹μ§€κ°€ μ—†μµλ‹λ‹¤.<br />
              μ•„λμ—μ„ λ©”μ‹μ§€λ¥Ό μ…λ ¥ν•λ©΄ μƒ λ…ΈνΈκ°€ μƒμ„±λ©λ‹λ‹¤.
            </div>
          ) : (
            <>
              {/* μ¨κΈ΄ λ©”μ‹μ§€ ν‘μ‹ ν† κΈ€ λ²„νΌ */}
              {μ¨κΉ€λ©”μ‹μ§€λ©λ΅.size > 0 && (
                <div style={{ 
                  padding: '8px 12px',
                  backgroundColor: '#f8f9fa',
                  borderRadius: '4px',
                  margin: '0 12px 12px 12px',
                  display: 'flex',
                  justifyContent: 'center'
                }}>
                  <button
                    onClick={μ¨κΈ΄λ©”μ‹μ§€ν‘μ‹ν† κΈ€}
                    style={{
                      padding: '4px 12px',
                      backgroundColor: μ¨κΉ€λ©”μ‹μ§€ν‘μ‹μ—¬λ¶€ ? '#dc3545' : '#6c757d',
                      color: 'white',
                      border: 'none',
                      borderRadius: '3px',
                      fontSize: '12px',
                      cursor: 'pointer'
                    }}
                  >
                    {μ¨κΉ€λ©”μ‹μ§€ν‘μ‹μ—¬λ¶€ ? 'μ¨κΈ΄ λ©”μ‹μ§€ κ°€λ¦¬κΈ°' : `μ¨κΈ΄ λ©”μ‹μ§€ ν‘μ‹ (${μ¨κΉ€λ©”μ‹μ§€λ©λ΅.size}κ°)`}
                  </button>
                </div>
              )}
              
              {/* ν΄λ” ν†µν•© λ©”μ‹μ§€ λ©λ΅ */}
              {ν΄λ”ν†µν•©μ±„ν…λ©λ΅.map((λ©”μ‹μ§€) => {
              // μΉ΄ν…κ³ λ¦¬ μƒ‰μƒ κ³„μ‚°
              const μΉ΄ν…κ³ λ¦¬λ©λ΅ = λ©”μ‹μ§€.μΉ΄ν…κ³ λ¦¬ ? λ©”μ‹μ§€.μΉ΄ν…κ³ λ¦¬.split(',').map(cat => cat.trim()) : [];
              const μΉ΄ν…κ³ λ¦¬μƒ‰μƒ = μΉ΄ν…κ³ λ¦¬λ©λ΅.length > 0 ? μ΅°ν•©μƒ‰μƒκ°€μ Έμ¤κΈ°(μΉ΄ν…κ³ λ¦¬λ©λ΅) : null;
              const μΉ΄ν…κ³ λ¦¬μ΄λ¦„ = μΉ΄ν…κ³ λ¦¬λ©λ΅.length > 0 ? μ΅°ν•©μ΄λ¦„κ°€μ Έμ¤κΈ°(μΉ΄ν…κ³ λ¦¬λ©λ΅, ν™μ„±μ„¤μ •.μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ„¤μ •) : '';
              
              // λ™μ  μΉ΄ν…κ³ λ¦¬ μ‚¬μ© μ—¬λ¶€μ— λ”°λ¥Έ ν‘μ‹ λ°©μ‹ κ²°μ •
              const λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ© = ν™μ„±μ„¤μ •.λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ© ?? false;
              
              let μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„°: string[] = [];
              if (λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ©) {
                // λ™μ  λ°©μ‹: μΉ΄ν…κ³ λ¦¬ μ΄λ¦„μ„ 3κΈ€μμ”© λ‚λ„μ–΄ μ„Έλ΅ ν‘μ‹
                if (μΉ΄ν…κ³ λ¦¬μ΄λ¦„ && μΉ΄ν…κ³ λ¦¬μ΄λ¦„.trim() !== '') {
                  μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„° = μΉ΄ν…κ³ λ¦¬μ΄λ¦„.match(/.{1,3}/g) || [];
                }
              } else {
                // κΈ°λ³Έ λ°©μ‹: μ‰Όν‘λ΅ κµ¬λ¶„λ κ° μΉ΄ν…κ³ λ¦¬λ¥Ό μ¤„λ°”κΏμΌλ΅ ν‘μ‹  
                μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„° = μΉ΄ν…κ³ λ¦¬λ©λ΅.filter(cat => cat && cat.trim() !== '');
              }
              
              // μ¤λ§νΈ μ‹κ°„ ν‘μ‹ κ³„μ‚°
              const μ‹κ°„ν‘μ‹μ •λ³΄ = μ¤λ§νΈμ‹κ°„ν¬λ§·ν…(λ©”μ‹μ§€.νƒ€μ„μ¤νƒ¬ν”„);
              const μ‹κ°„ν‚¤ = `ν†µν•©-${λ©”μ‹μ§€.μ•„μ΄λ””}`;
              const μ‹κ°„ν™•μ¥λ¨ = ν™•μ¥λμ‹κ°„λ©λ΅.has(μ‹κ°„ν‚¤);
              
              // λ©”μ‹μ§€ μ¨κΉ€ μƒνƒ ν™•μΈ
              const λ©”μ‹μ§€μ¨κΉ€λ¨ = μ¨κΉ€λ©”μ‹μ§€λ©λ΅.has(λ©”μ‹μ§€.μ•„μ΄λ””);
              
              // λ€ν™”ν• λ©”μ‹μ§€μ λ§ν’μ„  μ„μΉ ν™•μΈ (κ°λ³„ λ©”μ‹μ§€ μ €μ¥λ μ„μΉ μ°μ„ )
              const λ§ν’μ„ μ„μΉ = λ©”μ‹μ§€.λ§ν’μ„ μ„μΉ || (λ©”μ‹μ§€.μ‘μ„±μ ? 'μ™Όμ½' : undefined);
              const λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ = !!λ©”μ‹μ§€.μ‘μ„±μ;
              
              // μ¨κ²¨μ§„ λ©”μ‹μ§€μ΄κ³  ν‘μ‹ ν† κΈ€μ΄ κΊΌμ ΈμμΌλ©΄ λ λ”λ§ν•μ§€ μ•μ
              if (λ©”μ‹μ§€μ¨κΉ€λ¨ && !μ¨κΉ€λ©”μ‹μ§€ν‘μ‹μ—¬λ¶€) {
                return null;
              }
              
              return (
                <div 
                  key={`ν†µν•©-${λ©”μ‹μ§€.μ•„μ΄λ””}`} 
                  className={λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ ? "" : "μ±„ν…λ©”μ‹μ§€-μ•„μ΄ν…"} 
                  style={{ 
                    marginBottom: '12px', 
                    display: 'flex', 
                    alignItems: 'flex-start',
                    opacity: λ©”μ‹μ§€μ¨κΉ€λ¨ ? 0.4 : 1,
                    filter: λ©”μ‹μ§€μ¨κΉ€λ¨ ? 'blur(1px)' : 'none',
                    justifyContent: λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ && λ§ν’μ„ μ„μΉ === 'μ¤λ¥Έμ½' ? 'flex-end' : 'flex-start',
                    ...(λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ ? {} : {
                      padding: '8px 12px',
                      backgroundColor: '#f0f0f0',
                      borderRadius: '8px'
                    })
                  }}
                >
                  {/* λ…ΈνΈ μ¶μ² ν‘μ‹ */}
                  <div style={{
                    fontSize: '10px',
                    color: '#666',
                    backgroundColor: '#f0f0f0',
                    padding: '2px 6px',
                    borderRadius: '10px',
                    marginRight: '8px',
                    marginTop: '2px',
                    minWidth: 'fit-content',
                    whiteSpace: 'nowrap'
                  }}>
                    π“ {λ©”μ‹μ§€.λ…ΈνΈμ λ©}
                  </div>
                  
                  <div style={{ 
                    display: 'flex', 
                    alignItems: 'flex-start',
                    maxWidth: λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ ? '80%' : '100%',
                    width: λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ ? 'auto' : '100%'
                  }}>
                    {/* μΉ΄ν…κ³ λ¦¬ λΌλ²¨ μμ—­ */}
                    {μΉ΄ν…κ³ λ¦¬λ©λ΅.length > 0 && (
                      <div style={{
                        backgroundColor: μΉ΄ν…κ³ λ¦¬μƒ‰μƒ?.λ°°κ²½ || '#e0e0e0',
                        color: μΉ΄ν…κ³ λ¦¬μƒ‰μƒ?.ν…μ¤νΈ || '#333',
                        padding: '4px 6px',
                        borderRadius: '8px',
                        fontSize: '9px',
                        fontWeight: 'bold',
                        marginRight: '8px',
                        minWidth: '20px',
                        textAlign: 'center',
                        alignSelf: 'flex-start',
                        marginTop: '2px'
                      }}>
                        {/* π”¥ μ„Έλ΅μ„  ν‘μ‹ λ³µκµ¬ - μΉ΄ν…κ³ λ¦¬ μ΅°ν•©μ μ‹κ°μ  κµ¬λ¶„ */}
                        {λ™μ μΉ΄ν…κ³ λ¦¬μ‚¬μ© ? (
                          // λ™μ  μΉ΄ν…κ³ λ¦¬: μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„° μ‚¬μ©
                          μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„°.map((μ¤„, μΈλ±μ¤) => (
                            <div key={μΈλ±μ¤} style={{
                              fontSize: '11px',
                              color: μΉ΄ν…κ³ λ¦¬μƒ‰μƒ?.ν…μ¤νΈ,
                              fontWeight: 'bold',
                              textAlign: 'center',
                              lineHeight: '1.2',
                              marginBottom: '1px'
                            }}>
                              {μ¤„}
                            </div>
                          ))
                        ) : (
                          // κΈ°λ³Έ μΉ΄ν…κ³ λ¦¬: μ„Έλ΅μ„ μΌλ΅ κµ¬λ¶„ν•μ—¬ κ°€λ΅λ΅ ν‘μ‹
                          <div style={{
                            fontSize: '11px',
                            color: μΉ΄ν…κ³ λ¦¬μƒ‰μƒ?.ν…μ¤νΈ,
                            fontWeight: 'bold',
                            display: 'flex',
                            alignItems: 'center'
                          }}>
                            {μΉ΄ν…κ³ λ¦¬ν‘μ‹λ°μ΄ν„°.map((μΉ΄ν…κ³ λ¦¬, μΈλ±μ¤) => (
                              <React.Fragment key={μΈλ±μ¤}>
                                {μΈλ±μ¤ > 0 && (
                                  <span style={{ 
                                    margin: '0 3px',
                                    opacity: 0.7
                                  }}>|</span>
                                )}
                                <span>{μΉ΄ν…κ³ λ¦¬}</span>
                              </React.Fragment>
                            ))}
                          </div>
                        )}
                      </div>
                    )}
                    
                    <div style={{ flex: 1 }}>
                      {/* μ‘μ„±μ ν‘μ‹ */}
                      {λ©”μ‹μ§€.μ‘μ„±μ && (
                        <div style={{ 
                          fontSize: '11px', 
                          color: '#28a745',
                          fontWeight: 'bold',
                          marginBottom: '2px'
                        }}>
                          π’¬ {λ©”μ‹μ§€.μ‘μ„±μ}
                        </div>
                      )}
                      
                      <div 
                        className="μ±„ν…λ©”μ‹μ§€-ν…μ¤νΈ"
                        style={{
                          ...(λ€ν™”ν•λ©”μ‹μ§€μ—¬λ¶€ && {
                            backgroundColor: λ§ν’μ„ μ„μΉ === 'μ¤λ¥Έμ½' ? '#007bff' : '#e9ecef',
                            color: λ§ν’μ„ μ„μΉ === 'μ¤λ¥Έμ½' ? 'white' : '#333',
                            padding: '8px 12px',
                            borderRadius: '12px',
                            maxWidth: 'fit-content',
                            wordBreak: 'break-word',
                            border: λ§ν’μ„ μ„μΉ === 'μ™Όμ½' ? '1px solid #dee2e6' : 'none'
                          })
                        }}
                      >
                        {λ©”μ‹μ§€.ν…μ¤νΈ}
                      </div>
                    </div>
                  </div>
                  
                  {/* μ¨κΉ€ λ²„νΌ */}
                  <button
                    onClick={() => λ©”μ‹μ§€μ¨κΉ€ν† κΈ€(λ©”μ‹μ§€.μ•„μ΄λ””)}
                    style={{
                      background: 'none',
                      border: 'none',
                      cursor: 'pointer',
                      fontSize: '12px',
                      color: λ©”μ‹μ§€μ¨κΉ€λ¨ ? '#007bff' : '#999',
                      marginLeft: '4px',
                      marginRight: '4px',
                      padding: '2px 4px',
                      borderRadius: '3px'
                    }}
                    title={λ©”μ‹μ§€μ¨κΉ€λ¨ ? 'λ©”μ‹μ§€ ν‘μ‹ν•κΈ°' : 'λ©”μ‹μ§€ μ¨κΈ°κΈ°'}
                  >
                    {λ©”μ‹μ§€μ¨κΉ€λ¨ ? 'π‘οΈ' : 'π™'}
                  </button>
                  
                  {/* μ‹κ°„ ν‘μ‹ - μ„¤μ •μ— λ”°λΌ μ΅°κ±΄λ¶€ λ λ”λ§ */}
                  {ν™μ„±μ„¤μ •.μ‹κ°„ν‘μ‹μ—¬λ¶€ && (
                    <div 
                      className="μ‹κ°„ν‘μ‹-μμ—­"
                      onClick={() => μ‹κ°„ν‘μ‹ν† κΈ€(μ‹κ°„ν‚¤)}
                      style={{
                        marginLeft: '8px',
                        alignSelf: 'flex-end'
                      }}
                    >
                      {μ‹κ°„ν™•μ¥λ¨ ? μ‹κ°„ν‘μ‹μ •λ³΄.μƒμ„Έν‘μ‹ν…μ¤νΈ : μ‹κ°„ν‘μ‹μ •λ³΄.ν‘μ‹ν…μ¤νΈ}
                    </div>
                  )}
                </div>
              );
              })}
            </>
          )
        )}
      </div>

      {/* μ…λ ¥ λ°©μ‹λ³„ λ™μ  UI */}
      {ν™μ„±μ„¤μ •.μ…λ ¥λ°©μ‹ === 'μΉ΄ν…κ³ λ¦¬ν•' ? (
        <μΉ΄ν…κ³ λ¦¬μ…λ ¥
          μΉ΄ν…κ³ λ¦¬λ©λ΅={ν™μ„±μ„¤μ •.μΉ΄ν…κ³ λ¦¬λ©λ΅ || []}
          ν„μ¬μ…λ ¥κ°’={ν„μ¬μ…λ ¥κ°’}
          ν„μ¬μ…λ ¥κ°’μ„¤μ •={ν„μ¬μ…λ ¥κ°’μ„¤μ •}
          λ©”μ‹μ§€μ „μ†΅ν•κΈ°={λ©”μ‹μ§€μ „μ†΅ν•κΈ°}
          μ—”ν„°ν‚¤μ²λ¦¬={μ—”ν„°ν‚¤μ²λ¦¬}
          ν΄λ”μ„¤μ •={ν™μ„±ν΄λ”.ν΄λ”μ„¤μ •}
          ν΄λ”μ„¤μ •μ—…λ°μ΄νΈν•κΈ°={ν΄λ”μ„¤μ •μ—…λ°μ΄νΈν•κΈ°}
          ν΄λ”μ•„μ΄λ””={ν™μ„±ν΄λ”.μ•„μ΄λ””}
        />
      ) : ν™μ„±μ„¤μ •.μ…λ ¥λ°©μ‹ === 'λ€ν™”ν•' ? (
        <λ€ν™”ν•μ…λ ¥
          μΊλ¦­ν„°λ©λ΅={ν™μ„±μ„¤μ •.μΊλ¦­ν„°λ©λ΅ || []}
          ν„μ¬μ…λ ¥κ°’={ν„μ¬μ…λ ¥κ°’}
          ν„μ¬μ…λ ¥κ°’μ„¤μ •={ν„μ¬μ…λ ¥κ°’μ„¤μ •}
          λ©”μ‹μ§€μ „μ†΅ν•κΈ°={λ©”μ‹μ§€μ „μ†΅ν•κΈ°}
          μ—”ν„°ν‚¤μ²λ¦¬={μ—”ν„°ν‚¤μ²λ¦¬}
          ν΄λ”μ„¤μ •μ—…λ°μ΄νΈν•κΈ°={ν΄λ”μ„¤μ •μ—…λ°μ΄νΈν•κΈ°}
          ν΄λ”μ•„μ΄λ””={ν™μ„±ν΄λ”.μ•„μ΄λ””}
        />
      ) : (
        // κΈ°λ³Έ λ‹¨μμ±„ν… μ…λ ¥
        <div className="μ±„ν…μ…λ ¥-μμ—­">
          <input
            type="text"
            className="μ±„ν…μ…λ ¥-ν•„λ“"
            placeholder={
              ν™μ„±λ…ΈνΈ 
                ? "λ©”μ‹μ§€λ¥Ό μ…λ ¥ν•μ„Έμ”... (ν‚¤μ›λ“-λ΅ κ²€μƒ‰)" 
                : "μ²« λ©”μ‹μ§€λ¥Ό μ…λ ¥ν•λ©΄ μƒ λ…ΈνΈκ°€ μƒμ„±λ©λ‹λ‹¤... (ν‚¤μ›λ“-λ΅ κ²€μƒ‰)"
            }
            value={ν„μ¬μ…λ ¥κ°’}
            onChange={(e) => ν„μ¬μ…λ ¥κ°’μ„¤μ •(e.target.value)}
            onKeyDown={μ—”ν„°ν‚¤μ²λ¦¬}
          />
          <button 
            className="μ±„ν…μ „μ†΅-λ²„νΌ"
            onClick={λ‹¨μλ©”μ‹μ§€μ „μ†΅ν•κΈ°}
          >
            μ „μ†΅
          </button>
        </div>
      )}

      {/* μΉ΄ν…κ³ λ¦¬ νΈμ§‘ νμ—… */}
      <λ™μ μΉ΄ν…κ³ λ¦¬νμ—…
        νμ—…μ—΄λ¦Ό={νΈμ§‘νμ—…μ—΄λ¦Ό}
        μ„ νƒλμΉ΄ν…κ³ λ¦¬λ©λ΅={νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅}
        κΈ°μ΅΄μ΅°ν•©μ΄λ¦„={μ €μ¥λμ΅°ν•©μ΄λ¦„ν™•μΈ(νΈμ§‘λ€μƒμΉ΄ν…κ³ λ¦¬λ©λ΅, ν™μ„±μ„¤μ •?.μΉ΄ν…κ³ λ¦¬μ΅°ν•©μ„¤μ •)}
        νμ—…λ‹«κΈ°={νΈμ§‘νμ—…λ‹«κΈ°}
        μ΅°ν•©μ΄λ¦„ν™•μ •={μΉ΄ν…κ³ λ¦¬νΈμ§‘ν™•μ •}
      />
    </div>
  );
};

export default μ±„ν…ν¨λ„;