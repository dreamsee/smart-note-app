// μµμ ν™”λ Supabase λ°μ΄ν„°λ² μ΄μ¤ μ„λΉ„μ¤
import { νƒ€μ…λ“supabase } from './supabase';
import { ν΄λ”νƒ€μ…, λ…ΈνΈνƒ€μ…, μ±„ν…λ©”μ‹μ§€νƒ€μ…, ν΄λ”μ„¤μ •νƒ€μ… } from '../νƒ€μ…';

export class μµμ ν™”λλ°μ΄ν„°λ² μ΄μ¤μ„λΉ„μ¤ {
  
  // ============================================
  // π€ μµμ ν™”λ λ°μ΄ν„° λ΅λ”© (N+1 μΏΌλ¦¬ ν•΄κ²°)
  // ============================================
  
  async ν΄λ”λ©λ΅κ°€μ Έμ¤κΈ°(): Promise<ν΄λ”νƒ€μ…[]> {
    try {
      // π”¥ 1. λ¨λ“  λ°μ΄ν„°λ¥Ό JOINμΌλ΅ ν• λ²μ— κ°€μ Έμ¤κΈ° (μμ •λ κµ¬λ¬Έ)
      const { data: ν†µν•©λ°μ΄ν„°, error } = await νƒ€μ…λ“supabase
        .from('ν΄λ”λ©λ΅')
        .select(`
          *,
          λ…ΈνΈλ©λ΅ (
            *,
            μ±„ν…λ©”μ‹μ§€λ©λ΅ (*)
          )
        `)
        .order('μƒμ„±μ‹κ°„', { ascending: true });

      if (error) throw error;
      if (!ν†µν•©λ°μ΄ν„°) return [];

      // π”¥ 2. λ©”λ¨λ¦¬μ—μ„ λ°μ΄ν„° κµ¬μ΅°ν™” (νƒ€μ… μ•μ „ μ²λ¦¬)
      const ν΄λ”λ©λ΅: ν΄λ”νƒ€μ…[] = ν†µν•©λ°μ΄ν„°.map((ν΄λ”: any) => ({
        μ•„μ΄λ””: ν΄λ”.μ•„μ΄λ””,
        μ΄λ¦„: ν΄λ”.μ΄λ¦„,
        ν΄λ”μ„¤μ •: ν΄λ”.ν΄λ”μ„¤μ • as ν΄λ”μ„¤μ •νƒ€μ…,
        λ…ΈνΈλ©λ΅: (ν΄λ”.λ…ΈνΈλ©λ΅ || []).map((λ…ΈνΈ: any) => ({
          μ•„μ΄λ””: λ…ΈνΈ.μ•„μ΄λ””,
          μ λ©: λ…ΈνΈ.μ λ©,
          λ‚΄μ©: λ…ΈνΈ.λ‚΄μ©,
          μ”μ•½: λ…ΈνΈ.μ”μ•½ || undefined,
          νƒκ·Έλ©λ΅: λ…ΈνΈ.νƒκ·Έλ©λ΅ || undefined,
          λ…ΈνΈμ„¤μ •: λ…ΈνΈ.λ…ΈνΈμ„¤μ • || undefined,
          μƒμ„±μ‹κ°„: new Date(λ…ΈνΈ.μƒμ„±μ‹κ°„),
          μμ •μ‹κ°„: new Date(λ…ΈνΈ.μμ •μ‹κ°„),
          μ±„ν…λ©”μ‹μ§€λ©λ΅: this.λ©”μ‹μ§€κµ¬μ΅°ν™”ν•κΈ°(λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅ || [])
        }))
      }));

      console.log(`β… μµμ ν™”λ λ΅λ”© μ™„λ£: ${ν†µν•©λ°μ΄ν„°.length}κ° ν΄λ”, 1ν μΏΌλ¦¬`);
      return ν΄λ”λ©λ΅;

    } catch (μ—λ¬) {
      console.error('μµμ ν™”λ λ°μ΄ν„° λ΅λ“ μ‹¤ν¨:', μ—λ¬);
      throw μ—λ¬;
    }
  }

  // π”¥ λ©”μ‹μ§€ κµ¬μ΅°ν™” (ν•μ„λ©”μ‹μ§€ ν¬ν•¨) - λ‹¨μν™” λ²„μ „
  private λ©”μ‹μ§€κµ¬μ΅°ν™”ν•κΈ°(λ©”μ‹μ§€λ©λ΅: any[]): μ±„ν…λ©”μ‹μ§€νƒ€μ…[] {
    if (!λ©”μ‹μ§€λ©λ΅ || λ©”μ‹μ§€λ©λ΅.length === 0) return [];
    
    const λ©”μ‹μ§€λ§µ = new Map<string, μ±„ν…λ©”μ‹μ§€νƒ€μ…>();
    
    // 1λ‹¨κ³„: λ¨λ“  λ©”μ‹μ§€λ¥Ό λ§µμ— μ €μ¥
    λ©”μ‹μ§€λ©λ΅.forEach(λ©”μ‹μ§€ => {
      λ©”μ‹μ§€λ§µ.set(λ©”μ‹μ§€.μ•„μ΄λ””, {
        μ•„μ΄λ””: λ©”μ‹μ§€.μ•„μ΄λ””,
        ν…μ¤νΈ: λ©”μ‹μ§€.ν…μ¤νΈ,
        νƒ€μ„μ¤νƒ¬ν”„: new Date(λ©”μ‹μ§€.νƒ€μ„μ¤νƒ¬ν”„),
        μ‘μ„±μ: λ©”μ‹μ§€.μ‘μ„±μ || undefined,
        μΉ΄ν…κ³ λ¦¬: λ©”μ‹μ§€.μΉ΄ν…κ³ λ¦¬ || undefined,
        λ§ν’μ„ μ„μΉ: λ©”μ‹μ§€.λ§ν’μ„ μ„μΉ as 'μ™Όμ½' | 'μ¤λ¥Έμ½' || undefined,
        ν•μ„λ©”μ‹μ§€λ©λ΅: []
      });
    });

    // 2λ‹¨κ³„: ν•μ„λ©”μ‹μ§€ κ΄€κ³„ μ„¤μ •
    λ©”μ‹μ§€λ©λ΅.forEach(λ©”μ‹μ§€ => {
      if (λ©”μ‹μ§€.λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””) {
        const λ¶€λ¨λ©”μ‹μ§€ = λ©”μ‹μ§€λ§µ.get(λ©”μ‹μ§€.λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””);
        const ν„μ¬λ©”μ‹μ§€ = λ©”μ‹μ§€λ§µ.get(λ©”μ‹μ§€.μ•„μ΄λ””);
        if (λ¶€λ¨λ©”μ‹μ§€ && ν„μ¬λ©”μ‹μ§€) {
          λ¶€λ¨λ©”μ‹μ§€.ν•μ„λ©”μ‹μ§€λ©λ΅!.push(ν„μ¬λ©”μ‹μ§€);
        }
      }
    });

    // 3λ‹¨κ³„: λ£¨νΈ λ©”μ‹μ§€λ§ λ°ν™ (λ¶€λ¨κ°€ μ—†λ” λ©”μ‹μ§€)
    return Array.from(λ©”μ‹μ§€λ§µ.values())
      .filter(λ©”μ‹μ§€ => !λ©”μ‹μ§€λ©λ΅.find(μ›λ³Έ => μ›λ³Έ.μ•„μ΄λ”” === λ©”μ‹μ§€.μ•„μ΄λ”” && μ›λ³Έ.λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””))
      .sort((a, b) => a.νƒ€μ„μ¤νƒ¬ν”„.getTime() - b.νƒ€μ„μ¤νƒ¬ν”„.getTime());
  }

  // ============================================
  // π€ μ¦λ¶„ μ—…λ°μ΄νΈ (λ³€κ²½λ λ¶€λ¶„λ§ λ™κΈ°ν™”)
  // ============================================

  async μ¦λ¶„μ—…λ°μ΄νΈν•κΈ°(λ§μ§€λ§‰λ™κΈ°ν™”μ‹κ°„: Date): Promise<Partial<ν΄λ”νƒ€μ…>[]> {
    try {
      // λ‹¨μν™”λ μ¦λ¶„ μ—…λ°μ΄νΈ (λ³µμ΅ν• JOIN λ€μ‹  κΈ°λ³Έ μΏΌλ¦¬ μ‚¬μ©)
      const { data: λ³€κ²½λν΄λ”, error } = await νƒ€μ…λ“supabase
        .from('ν΄λ”λ©λ΅')
        .select(`
          *,
          λ…ΈνΈλ©λ΅ (
            *,
            μ±„ν…λ©”μ‹μ§€λ©λ΅ (*)
          )
        `)
        .gt('μμ •μ‹κ°„', λ§μ§€λ§‰λ™κΈ°ν™”μ‹κ°„.toISOString())
        .order('μμ •μ‹κ°„', { ascending: false });

      if (error) throw error;

      console.log(`β… μ¦λ¶„ μ—…λ°μ΄νΈ: ${λ³€κ²½λν΄λ”?.length || 0}κ° ν•­λ© λ³€κ²½`);
      return λ³€κ²½λν΄λ”?.map((ν΄λ”: any) => ({
        μ•„μ΄λ””: ν΄λ”.μ•„μ΄λ””,
        μ΄λ¦„: ν΄λ”.μ΄λ¦„,
        ν΄λ”μ„¤μ •: ν΄λ”.ν΄λ”μ„¤μ • as ν΄λ”μ„¤μ •νƒ€μ…,
        λ…ΈνΈλ©λ΅: (ν΄λ”.λ…ΈνΈλ©λ΅ || []).map((λ…ΈνΈ: any) => ({
          μ•„μ΄λ””: λ…ΈνΈ.μ•„μ΄λ””,
          μ λ©: λ…ΈνΈ.μ λ©,
          λ‚΄μ©: λ…ΈνΈ.λ‚΄μ©,
          μ”μ•½: λ…ΈνΈ.μ”μ•½ || undefined,
          νƒκ·Έλ©λ΅: λ…ΈνΈ.νƒκ·Έλ©λ΅ || undefined,
          λ…ΈνΈμ„¤μ •: λ…ΈνΈ.λ…ΈνΈμ„¤μ • || undefined,
          μƒμ„±μ‹κ°„: new Date(λ…ΈνΈ.μƒμ„±μ‹κ°„),
          μμ •μ‹κ°„: new Date(λ…ΈνΈ.μμ •μ‹κ°„),
          μ±„ν…λ©”μ‹μ§€λ©λ΅: this.λ©”μ‹μ§€κµ¬μ΅°ν™”ν•κΈ°(λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅ || [])
        }))
      })) || [];

    } catch (μ—λ¬) {
      console.error('μ¦λ¶„ μ—…λ°μ΄νΈ μ‹¤ν¨:', μ—λ¬);
      throw μ—λ¬;
    }
  }

  // ============================================
  // π€ λ³‘λ ¬ μ²λ¦¬ μµμ ν™”
  // ============================================

  async λ³‘λ ¬ν΄λ”λ©λ΅κ°€μ Έμ¤κΈ°(): Promise<ν΄λ”νƒ€μ…[]> {
    try {
      // 1. ν΄λ” λ©λ΅ λ¨Όμ € κ°€μ Έμ¤κΈ°
      const { data: ν΄λ”λ°μ΄ν„°, error: ν΄λ”μ—λ¬ } = await νƒ€μ…λ“supabase
        .from('ν΄λ”λ©λ΅')
        .select('*')
        .order('μƒμ„±μ‹κ°„', { ascending: true });

      if (ν΄λ”μ—λ¬ || !ν΄λ”λ°μ΄ν„°) throw ν΄λ”μ—λ¬;

      // 2. λ¨λ“  ν΄λ”μ λ…ΈνΈλ¥Ό λ³‘λ ¬λ΅ κ°€μ Έμ¤κΈ°
      const λ…ΈνΈκ²°κ³Όλ©λ΅ = await Promise.all(
        ν΄λ”λ°μ΄ν„°.map(async (ν΄λ”) => {
          const { data: λ…ΈνΈλ°μ΄ν„°, error: λ…ΈνΈμ—λ¬ } = await νƒ€μ…λ“supabase
            .from('λ…ΈνΈλ©λ΅')
            .select(`
              *,
              μ±„ν…λ©”μ‹μ§€λ©λ΅(
                *,
                ν•μ„λ©”μ‹μ§€:μ±„ν…λ©”μ‹μ§€λ©λ΅!μ±„ν…λ©”μ‹μ§€λ©λ΅_λ¶€λ¨λ©”μ‹μ§€μ•„μ΄λ””_fkey(*)
              )
            `)
            .eq('ν΄λ”μ•„μ΄λ””', ν΄λ”.μ•„μ΄λ””)
            .order('μƒμ„±μ‹κ°„', { ascending: true });

          if (λ…ΈνΈμ—λ¬) throw λ…ΈνΈμ—λ¬;
          return { ν΄λ”, λ…ΈνΈλ©λ΅: λ…ΈνΈλ°μ΄ν„° || [] };
        })
      );

      // 3. κ²°κ³Ό κµ¬μ΅°ν™”
      const ν΄λ”λ©λ΅: ν΄λ”νƒ€μ…[] = λ…ΈνΈκ²°κ³Όλ©λ΅.map(({ ν΄λ”, λ…ΈνΈλ©λ΅ }) => ({
        μ•„μ΄λ””: ν΄λ”.μ•„μ΄λ””,
        μ΄λ¦„: ν΄λ”.μ΄λ¦„,
        ν΄λ”μ„¤μ •: ν΄λ”.ν΄λ”μ„¤μ • as ν΄λ”μ„¤μ •νƒ€μ…,
        λ…ΈνΈλ©λ΅: λ…ΈνΈλ©λ΅.map((λ…ΈνΈ: any) => ({
          μ•„μ΄λ””: λ…ΈνΈ.μ•„μ΄λ””,
          μ λ©: λ…ΈνΈ.μ λ©,
          λ‚΄μ©: λ…ΈνΈ.λ‚΄μ©,
          μ”μ•½: λ…ΈνΈ.μ”μ•½ || undefined,
          νƒκ·Έλ©λ΅: λ…ΈνΈ.νƒκ·Έλ©λ΅ || undefined,
          λ…ΈνΈμ„¤μ •: λ…ΈνΈ.λ…ΈνΈμ„¤μ • || undefined,
          μƒμ„±μ‹κ°„: new Date(λ…ΈνΈ.μƒμ„±μ‹κ°„),
          μμ •μ‹κ°„: new Date(λ…ΈνΈ.μμ •μ‹κ°„),
          μ±„ν…λ©”μ‹μ§€λ©λ΅: this.λ©”μ‹μ§€κµ¬μ΅°ν™”ν•κΈ°(λ…ΈνΈ.μ±„ν…λ©”μ‹μ§€λ©λ΅ || [])
        }))
      }));

      console.log(`β… λ³‘λ ¬ λ΅λ”© μ™„λ£: ${ν΄λ”λ©λ΅.length}κ° ν΄λ”`);
      return ν΄λ”λ©λ΅;

    } catch (μ—λ¬) {
      console.error('λ³‘λ ¬ λ°μ΄ν„° λ΅λ“ μ‹¤ν¨:', μ—λ¬);
      throw μ—λ¬;
    }
  }

  // ============================================
  // π€ μ¤λ§νΈ μΊμ‹± μ‹μ¤ν…
  // ============================================

  private μΊμ‹μ €μ¥μ† = new Map<string, { λ°μ΄ν„°: any; λ§λ£μ‹κ°„: number }>();
  private μΊμ‹μ ν¨μ‹κ°„ = 5 * 60 * 1000; // 5λ¶„

  async μΊμ‹λν΄λ”λ©λ΅κ°€μ Έμ¤κΈ°(): Promise<ν΄λ”νƒ€μ…[]> {
    const μΊμ‹ν‚¤ = 'folder-list';
    const μΊμ‹λν•­λ© = this.μΊμ‹μ €μ¥μ†.get(μΊμ‹ν‚¤);

    // μΊμ‹κ°€ μ ν¨ν• κ²½μ°
    if (μΊμ‹λν•­λ© && Date.now() < μΊμ‹λν•­λ©.λ§λ£μ‹κ°„) {
      console.log('β… μΊμ‹μ—μ„ λ°μ΄ν„° λ°ν™');
      return μΊμ‹λν•­λ©.λ°μ΄ν„°;
    }

    // μΊμ‹κ°€ μ—†κ±°λ‚ λ§λ£λ κ²½μ° μƒλ΅ λ΅λ“
    const μƒλ°μ΄ν„° = await this.ν΄λ”λ©λ΅κ°€μ Έμ¤κΈ°();
    
    // μΊμ‹μ— μ €μ¥
    this.μΊμ‹μ €μ¥μ†.set(μΊμ‹ν‚¤, {
      λ°μ΄ν„°: μƒλ°μ΄ν„°,
      λ§λ£μ‹κ°„: Date.now() + this.μΊμ‹μ ν¨μ‹κ°„
    });

    return μƒλ°μ΄ν„°;
  }

  // μΊμ‹ λ¬΄ν¨ν™”
  μΊμ‹λ¬΄ν¨ν™”ν•κΈ°(ν‚¤?: string) {
    if (ν‚¤) {
      this.μΊμ‹μ €μ¥μ†.delete(ν‚¤);
    } else {
      this.μΊμ‹μ €μ¥μ†.clear();
    }
    console.log('β… μΊμ‹ λ¬΄ν¨ν™” μ™„λ£');
  }
}

// μ‹±κΈ€ν†¤ μΈμ¤ν„΄μ¤
export const μµμ ν™”λλ°μ΄ν„°λ² μ΄μ¤ = new μµμ ν™”λλ°μ΄ν„°λ² μ΄μ¤μ„λΉ„μ¤();